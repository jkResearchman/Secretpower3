try{!function($){var tag2attr={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href"},key=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","fragment"],aliases={anchor:"fragment"},parser={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},querystring_parser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,fragment_parser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g;$.fn.url=function(strictMode){var url="";return this.length&&(url=$(this).attr(function(elm){var tn=elm.tagName;return void 0!==tn?tag2attr[tn.toLowerCase()]:tn}(this[0]))||""),$.url(url,strictMode)},$.url=function(url,strictMode){return 1===arguments.length&&!0===url&&(strictMode=!0,url=void 0),strictMode=strictMode||!1,{data:function(url,strictMode){for(var str=decodeURI(url),res=parser[strictMode?"strict":"loose"].exec(str),uri={attr:{},param:{},seg:{}},i=14;i--;)uri.attr[key[i]]=res[i]||"";return uri.param.query={},uri.param.fragment={},uri.attr.query.replace(querystring_parser,function($0,$1,$2){$1&&(uri.param.query[$1]=$2)}),uri.attr.fragment.replace(fragment_parser,function($0,$1,$2){$1&&(uri.param.fragment[$1]=$2)}),uri.seg.path=uri.attr.path.replace(/^\/+|\/+$/g,"").split("/"),uri.seg.fragment=uri.attr.fragment.replace(/^\/+|\/+$/g,"").split("/"),uri.attr.base=uri.attr.host?uri.attr.protocol+"://"+uri.attr.host+(uri.attr.port?":"+uri.attr.port:""):"",uri}(url=url||window.location.toString(),strictMode),attr:function(attr){return void 0!==(attr=aliases[attr]||attr)?this.data.attr[attr]:this.data.attr},param:function(param){return void 0!==param?this.data.param.query[param]:this.data.param.query},fparam:function(param){return void 0!==param?this.data.param.fragment[param]:this.data.param.fragment},segment:function(seg){return void 0===seg?this.data.seg.path:(seg=seg<0?this.data.seg.path.length+seg:seg-1,this.data.seg.path[seg])},fsegment:function(seg){return void 0===seg?this.data.seg.fragment:(seg=seg<0?this.data.seg.fragment.length+seg:seg-1,this.data.seg.fragment[seg])}}}}(jQuery),function(){var Backbone,root=this,previousBackbone=root.Backbone,array=[],push=array.push,slice=array.slice,splice=array.splice;(Backbone="undefined"!=typeof exports?exports:root.Backbone={}).VERSION="1.0.0";var _=root._;_||"undefined"==typeof require||(_=require("underscore")),Backbone.$=root.jQuery||root.Zepto||root.ender||root.$,Backbone.noConflict=function(){return root.Backbone=previousBackbone,this},Backbone.emulateHTTP=!1,Backbone.emulateJSON=!1;var Events=Backbone.Events={on:function(name,callback,context){return eventsApi(this,"on",name,[callback,context])&&callback&&(this._events||(this._events={}),(this._events[name]||(this._events[name]=[])).push({callback:callback,context:context,ctx:context||this})),this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this,once=_.once(function(){self.off(name,once),callback.apply(this,arguments)});return once._callback=callback,this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context)return this._events={},this;for(i=0,l=(names=name?[name]:_.keys(this._events)).length;i<l;i++)if(name=names[i],events=this._events[name]){if(this._events[name]=retain=[],callback||context)for(j=0,k=events.length;j<k;j++)ev=events[j],(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context)&&retain.push(ev);retain.length||delete this._events[name]}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name],allEvents=this._events.all;return events&&triggerEvents(events,args),allEvents&&triggerEvents(allEvents,arguments),this},stopListening:function(obj,name,callback){var listeners=this._listeners;if(!listeners)return this;var deleteListener=!name&&!callback;for(var id in"object"==typeof name&&(callback=this),obj&&((listeners={})[obj._listenerId]=obj),listeners)listeners[id].off(name,callback,this),deleteListener&&delete this._listeners[id];return this}},eventSplitter=/\s+/,eventsApi=function(obj,action,name,rest){if(!name)return!0;if("object"==typeof name){for(var key in name)obj[action].apply(obj,[key,name[key]].concat(rest));return!1}if(eventSplitter.test(name)){for(var names=name.split(eventSplitter),i=0,l=names.length;i<l;i++)obj[action].apply(obj,[names[i]].concat(rest));return!1}return!0},triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx);return;case 1:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:for(;++i<l;)(ev=events[i]).callback.apply(ev.ctx,args)}};_.each({listenTo:"on",listenToOnce:"once"},function(implementation,method){Events[method]=function(obj,name,callback){var listeners=this._listeners||(this._listeners={});return"object"==typeof name&&(callback=this),(listeners[obj._listenerId||(obj._listenerId=_.uniqueId("l"))]=obj)[implementation](name,callback,this),this}}),Events.bind=Events.on,Events.unbind=Events.off,_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var defaults,attrs=attributes||{};options=options||{},this.cid=_.uniqueId("c"),this.attributes={},_.extend(this,_.pick(options,modelOptions)),options.parse&&(attrs=this.parse(attrs,options)||{}),(defaults=_.result(this,"defaults"))&&(attrs=_.defaults({},attrs,defaults)),this.set(attrs,options),this.changed={},this.initialize.apply(this,arguments)},modelOptions=["url","urlRoot","collection"];_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(options){return _.clone(this.attributes)},sync:function(){return Backbone.sync.apply(this,arguments)},get:function(attr){return this.attributes[attr]},escape:function(attr){return _.escape(this.get(attr))},has:function(attr){return null!=this.get(attr)},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(null==key)return this;if("object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options=options||{},!this._validate(attrs,options))return!1;for(attr in unset=options.unset,silent=options.silent,changes=[],changing=this._changing,this._changing=!0,changing||(this._previousAttributes=_.clone(this.attributes),this.changed={}),current=this.attributes,prev=this._previousAttributes,this.idAttribute in attrs&&(this.id=attrs[this.idAttribute]),attrs)val=attrs[attr],_.isEqual(current[attr],val)||changes.push(attr),_.isEqual(prev[attr],val)?delete this.changed[attr]:this.changed[attr]=val,unset?delete current[attr]:current[attr]=val;if(!silent){changes.length&&(this._pending=!0);for(var i=0,l=changes.length;i<l;i++)this.trigger("change:"+changes[i],this,current[changes[i]],options)}if(changing)return this;if(!silent)for(;this._pending;)this._pending=!1,this.trigger("change",this,options);return this._pending=!1,this._changing=!1,this},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:!0}))},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:!0}))},hasChanged:function(attr){return null==attr?!_.isEmpty(this.changed):_.has(this.changed,attr)},changedAttributes:function(diff){if(!diff)return!!this.hasChanged()&&_.clone(this.changed);var val,changed=!1,old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff)_.isEqual(old[attr],val=diff[attr])||((changed=changed||{})[attr]=val);return changed},previous:function(attr){return null!=attr&&this._previousAttributes?this._previousAttributes[attr]:null},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(options){void 0===(options=options?_.clone(options):{}).parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){if(!model.set(model.parse(resp,options),options))return!1;success&&success(model,resp,options),model.trigger("sync",model,resp,options)},wrapError(this,options),this.sync("read",this,options)},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(null==key||"object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,attrs&&(!options||!options.wait)&&!this.set(attrs,options))return!1;if(options=_.extend({validate:!0},options),!this._validate(attrs,options))return!1;attrs&&options.wait&&(this.attributes=_.extend({},attributes,attrs)),void 0===options.parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait&&(serverAttrs=_.extend(attrs||{},serverAttrs)),_.isObject(serverAttrs)&&!model.set(serverAttrs,options))return!1;success&&success(model,resp,options),model.trigger("sync",model,resp,options)},wrapError(this,options),"patch"==(method=this.isNew()?"create":options.patch?"patch":"update")&&(options.attrs=attrs),xhr=this.sync(method,this,options),attrs&&options.wait&&(this.attributes=attributes),xhr},destroy:function(options){options=options?_.clone(options):{};function destroy(){model.trigger("destroy",model,model.collection,options)}var model=this,success=options.success;if(options.success=function(resp){(options.wait||model.isNew())&&destroy(),success&&success(model,resp,options),model.isNew()||model.trigger("sync",model,resp,options)},this.isNew())return options.success(),!1;wrapError(this,options);var xhr=this.sync("delete",this,options);return options.wait||destroy(),xhr},url:function(){var base=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?base:base+("/"===base.charAt(base.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(options){return this._validate({},_.extend(options||{},{validate:!0}))},_validate:function(attrs,options){if(!options.validate||!this.validate)return!0;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;return!error||(this.trigger("invalid",this,error,_.extend(options||{},{validationError:error})),!1)}});_.each(["keys","values","pairs","invert","pick","omit"],function(method){Model.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.attributes),_[method].apply(_,args)}});var Collection=Backbone.Collection=function(models,options){(options=options||{}).url&&(this.url=options.url),options.model&&(this.model=options.model),void 0!==options.comparator&&(this.comparator=options.comparator),this._reset(),this.initialize.apply(this,arguments),models&&this.reset(models,_.extend({silent:!0},options))},setOptions={add:!0,remove:!0,merge:!0},addOptions={add:!0,merge:!1,remove:!1};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})},sync:function(){return Backbone.sync.apply(this,arguments)},add:function(models,options){return this.set(models,_.defaults(options||{},addOptions))},remove:function(models,options){var i,l,index,model;for(options=options||{},i=0,l=(models=_.isArray(models)?models.slice():[models]).length;i<l;i++)(model=this.get(models[i]))&&(delete this._byId[model.id],delete this._byId[model.cid],index=this.indexOf(model),this.models.splice(index,1),this.length--,options.silent||(options.index=index,model.trigger("remove",model,this,options)),this._removeReference(model));return this},set:function(models,options){var i,l,model,existing,sort;(options=_.defaults(options||{},setOptions)).parse&&(models=this.parse(models,options)),_.isArray(models)||(models=models?[models]:[]);var at=options.at,sortable=this.comparator&&null==at&&!1!==options.sort,sortAttr=_.isString(this.comparator)?this.comparator:null,toAdd=[],toRemove=[],modelMap={};for(i=0,l=models.length;i<l;i++)(model=this._prepareModel(models[i],options))&&((existing=this.get(model))?(options.remove&&(modelMap[existing.cid]=!0),options.merge&&(existing.set(model.attributes,options),sortable&&!sort&&existing.hasChanged(sortAttr)&&(sort=!0))):options.add&&(toAdd.push(model),model.on("all",this._onModelEvent,this),null!=(this._byId[model.cid]=model).id&&(this._byId[model.id]=model)));if(options.remove){for(i=0,l=this.length;i<l;++i)modelMap[(model=this.models[i]).cid]||toRemove.push(model);toRemove.length&&this.remove(toRemove,options)}if(toAdd.length&&(sortable&&(sort=!0),this.length+=toAdd.length,null!=at?splice.apply(this.models,[at,0].concat(toAdd)):push.apply(this.models,toAdd)),sort&&this.sort({silent:!0}),options.silent)return this;for(i=0,l=toAdd.length;i<l;i++)(model=toAdd[i]).trigger("add",model,this,options);return sort&&this.trigger("sort",this,options),this},reset:function(models,options){options=options||{};for(var i=0,l=this.models.length;i<l;i++)this._removeReference(this.models[i]);return options.previousModels=this.models,this._reset(),this.add(models,_.extend({silent:!0},options)),options.silent||this.trigger("reset",this,options),this},push:function(model,options){return model=this._prepareModel(model,options),this.add(model,_.extend({at:this.length},options)),model},pop:function(options){var model=this.at(this.length-1);return this.remove(model,options),model},unshift:function(model,options){return model=this._prepareModel(model,options),this.add(model,_.extend({at:0},options)),model},shift:function(options){var model=this.at(0);return this.remove(model,options),model},slice:function(begin,end){return this.models.slice(begin,end)},get:function(obj){if(null!=obj)return this._byId[null!=obj.id?obj.id:obj.cid||obj]},at:function(index){return this.models[index]},where:function(attrs,first){return _.isEmpty(attrs)?first?void 0:[]:this[first?"find":"filter"](function(model){for(var key in attrs)if(attrs[key]!==model.get(key))return!1;return!0})},findWhere:function(attrs){return this.where(attrs,!0)},sort:function(options){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return options=options||{},_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(_.bind(this.comparator,this)),options.silent||this.trigger("sort",this,options),this},sortedIndex:function(model,value,context){value=value||this.comparator;var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _.sortedIndex(this.models,model,iterator,context)},pluck:function(attr){return _.invoke(this.models,"get",attr)},fetch:function(options){void 0===(options=options?_.clone(options):{}).parse&&(options.parse=!0);var success=options.success,collection=this;return options.success=function(resp){var method=options.reset?"reset":"set";collection[method](resp,options),success&&success(collection,resp,options),collection.trigger("sync",collection,resp,options)},wrapError(this,options),this.sync("read",this,options)},create:function(model,options){if(options=options?_.clone(options):{},!(model=this._prepareModel(model,options)))return!1;options.wait||this.add(model,options);var collection=this,success=options.success;return options.success=function(resp){options.wait&&collection.add(model,options),success&&success(model,resp,options)},model.save(null,options),model},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(attrs,options){if(attrs instanceof Model)return attrs.collection||(attrs.collection=this),attrs;var model=new((options=options||{}).collection=this).model(attrs,options);return model._validate(attrs,options)?model:(this.trigger("invalid",this,attrs,options),!1)},_removeReference:function(model){this===model.collection&&delete model.collection,model.off("all",this._onModelEvent,this)},_onModelEvent:function(event,model,collection,options){("add"!==event&&"remove"!==event||collection===this)&&("destroy"===event&&this.remove(model,options),model&&event==="change:"+model.idAttribute&&(delete this._byId[model.previous(model.idAttribute)],null!=model.id&&(this._byId[model.id]=model)),this.trigger.apply(this,arguments))}});_.each(["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"],function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.models),_[method].apply(_,args)}});_.each(["groupBy","countBy","sortBy"],function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _[method](this.models,iterator,context)}});var View=Backbone.View=function(options){this.cid=_.uniqueId("view"),this._configure(options||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},delegateEventSplitter=/^(\S+)\s*(.*)$/,viewOptions=["model","collection","el","id","attributes","className","tagName","events"];_.extend(View.prototype,Events,{tagName:"div",$:function(selector){return this.$el.find(selector)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(element,delegate){return this.$el&&this.undelegateEvents(),this.$el=element instanceof Backbone.$?element:Backbone.$(element),this.el=this.$el[0],!1!==delegate&&this.delegateEvents(),this},delegateEvents:function(events){if(!(events=events||_.result(this,"events")))return this;for(var key in this.undelegateEvents(),events){var method=events[key];if(_.isFunction(method)||(method=this[events[key]]),method){var match=key.match(delegateEventSplitter),eventName=match[1],selector=match[2];method=_.bind(method,this),eventName+=".delegateEvents"+this.cid,""===selector?this.$el.on(eventName,method):this.$el.on(eventName,selector,method)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(options){this.options&&(options=_.extend({},_.result(this,"options"),options)),_.extend(this,_.pick(options,viewOptions)),this.options=options},_ensureElement:function(){if(this.el)this.setElement(_.result(this,"el"),!1);else{var attrs=_.extend({},_.result(this,"attributes"));this.id&&(attrs.id=_.result(this,"id")),this.className&&(attrs.class=_.result(this,"className"));var $el=Backbone.$("<"+_.result(this,"tagName")+">").attr(attrs);this.setElement($el,!1)}}}),Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options=options||{},{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:"json"};if(options.url||(params.url=_.result(model,"url")||urlError()),null!=options.data||!model||"create"!==method&&"update"!==method&&"patch"!==method||(params.contentType="application/json",params.data=JSON.stringify(options.attrs||model.toJSON(options))),options.emulateJSON&&(params.contentType="application/x-www-form-urlencoded",params.data=params.data?{model:params.data}:{}),options.emulateHTTP&&("PUT"===type||"DELETE"===type||"PATCH"===type)){params.type="POST",options.emulateJSON&&(params.data._method=type);var beforeSend=options.beforeSend;options.beforeSend=function(xhr){if(xhr.setRequestHeader("X-HTTP-Method-Override",type),beforeSend)return beforeSend.apply(this,arguments)}}"GET"===params.type||options.emulateJSON||(params.processData=!1),"PATCH"!==params.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var xhr=options.xhr=Backbone.ajax(_.extend(params,options));return model.trigger("request",model,xhr,options),xhr};var methodMap={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var Router=Backbone.Router=function(options){(options=options||{}).routes&&(this.routes=options.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){_.isRegExp(route)||(route=this._routeToRegExp(route)),_.isFunction(name)&&(callback=name,name=""),callback=callback||this[name];var router=this;return Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);callback&&callback.apply(router,args),router.trigger.apply(router,["route:"+name].concat(args)),router.trigger("route",name,args),Backbone.history.trigger("route",router,name,args)}),this},navigate:function(fragment,options){return Backbone.history.navigate(fragment,options),this},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var route,routes=_.keys(this.routes);null!=(route=routes.pop());)this.route(route,this.routes[route])}},_routeToRegExp:function(route){return route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/]+)"}).replace(splatParam,"(.*?)"),new RegExp("^"+route+"$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param){return param?decodeURIComponent(param):null})}});var History=Backbone.History=function(){this.handlers=[],_.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},routeStripper=/^[#\/]|\s+$/g,rootStripper=/^\/+|\/+$/g,isExplorer=/msie [\w.]+/,trailingSlash=/\/$/;History.started=!1,_.extend(History.prototype,Events,{interval:50,getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:""},getFragment:function(fragment,forcePushState){if(null==fragment)if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=this.location.pathname;var root=this.root.replace(trailingSlash,"");fragment.indexOf(root)||(fragment=fragment.substr(root.length))}else fragment=this.getHash();return fragment.replace(routeStripper,"")},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=!0,this.options=_.extend({},{root:"/"},this.options,options),this.root=this.options.root,this._wantsHashChange=!1!==this.options.hashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment(),docMode=document.documentMode,oldIE=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7);this.root=("/"+this.root+"/").replace(rootStripper,"/"),oldIE&&this._wantsHashChange&&(this.iframe=Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(fragment)),this._hasPushState?Backbone.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!oldIE?Backbone.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=fragment;var loc=this.location,atRoot=loc.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!atRoot?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&atRoot&&loc.hash&&(this.fragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+loc.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){Backbone.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),History.started=!1},route:function(route,callback){this.handlers.unshift({route:route,callback:callback})},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe&&(current=this.getFragment(this.getHash(this.iframe))),current===this.fragment)return!1;this.iframe&&this.navigate(current),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(fragmentOverride){var fragment=this.fragment=this.getFragment(fragmentOverride);return _.any(this.handlers,function(handler){if(handler.route.test(fragment))return handler.callback(fragment),!0})},navigate:function(fragment,options){if(!History.started)return!1;if(options&&!0!==options||(options={trigger:options}),fragment=this.getFragment(fragment||""),this.fragment!==fragment){this.fragment=fragment;var url=this.root+fragment;if(this._hasPushState)this.history[options.replace?"replaceState":"pushState"]({},document.title,url);else{if(!this._wantsHashChange)return this.location.assign(url);this._updateHash(this.location,fragment,options.replace),this.iframe&&fragment!==this.getFragment(this.getHash(this.iframe))&&(options.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,fragment,options.replace))}options.trigger&&this.loadUrl(fragment)}},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+"#"+fragment)}else location.hash="#"+fragment}}),Backbone.history=new History;Model.extend=Collection.extend=Router.extend=View.extend=History.extend=function(protoProps,staticProps){var child,parent=this;child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},_.extend(child,parent,staticProps);function Surrogate(){this.constructor=child}return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&_.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};var urlError=function(){throw new Error('A "url" property or function must be specified')},wrapError=function(model,options){var error=options.error;options.error=function(resp){error&&error(model,resp,options),model.trigger("error",model,resp,options)}}}.call(this),function(window){function CustomEvent(eventName,options){options=options||{bubbles:!1,cancelable:!1,detail:void 0};var e=document.createEvent("CustomEvent");return e.initCustomEvent(eventName,options.bubbles,options.cancelable,options.detail),e}window.CustomEvent||(CustomEvent.prototype=window.Event.prototype,window.CustomEvent=CustomEvent)}(this),function(r,global){"use strict";var DEFAULT_POSTMESSAGE_OPTIONS={targetOrigin:"*"},allowedOrigins=[".*"],re_postMessageAllowedOrigin=compileOriginRegExp(allowedOrigins),messageNamespaces=[".postMessage"],re_messageNamespaces=compileNamespaceRegExp(messageNamespaces),proxies={},listening=!1;function receiveMessage(e){if(e.origin===location.origin||re_postMessageAllowedOrigin.test(e.origin)||"null"===e.origin)try{var message=JSON.parse(e.data),type=message.type;if(!re_messageNamespaces.test(type))return;var namespace=type.split(".",2)[1];if(proxies[namespace])for(var proxyWith=proxies[namespace],i=0;i<proxyWith.targets.length;i++)r.frames.postMessage(proxyWith.targets[i],type,message.data,message.options);var customEvent=new CustomEvent(type,{detail:message.data});customEvent.source=e.source,global.dispatchEvent(customEvent)}catch(x){}}function _addEventListener(type,handler,useCapture){"addEventListener"in global?global.addEventListener(type,handler,useCapture):"attachEvent"in global&&global.attachEvent("on"+type,handler)}function _removeEventListener(type,handler){"removeEventListener"in global?global.removeEventListener(type,handler):"detachEvent"in global&&global.attachEvent("on"+type,handler)}function compileOriginRegExp(origins){return new RegExp("^http(s)?:\\/\\/"+origins.join("|")+"$","i")}function compileNamespaceRegExp(namespaces){return new RegExp("\\.(?:"+namespaces.join("|")+")$")}var frames=r.frames={postMessage:function(target,type,data,options){for(var key in/\..+$/.test(type)||(type+=".postMessage"),options=options||{},DEFAULT_POSTMESSAGE_OPTIONS)options.hasOwnProperty(key)||(options[key]=DEFAULT_POSTMESSAGE_OPTIONS[key]);target.postMessage(JSON.stringify({type:type,data:data,options:options}),options.targetOrigin)},receiveMessage:function(source,type,callback,context){"string"==typeof source&&(context=callback,callback=type,type=source,source=null),context=context||this;function scoped(e){source&&source!==e.source&&source.contentWindow!==e.source||callback.apply(context,arguments)}return _addEventListener(type,scoped),{off:function(){_removeEventListener(type,scoped)}}},proxy:function(namespace,targets){this.listen(namespace),"[object Array]"!==Object.prototype.toString.call(targets)&&(targets=[targets]);var namespaceProxies=proxies[namespace];namespaceProxies?namespaceProxies.targets=[].concat(namespaceProxies.targets,target):namespaceProxies={targets:targets},proxies[namespace]=namespaceProxies},receiveMessageOnce:function(source,type,callback,context){var listener=frames.receiveMessage(source,type,function(){callback&&callback.apply(this,arguments),listener.off()},context);return listener},addPostMessageOrigin:function(origin){!function(origin){return/\*/.test(origin)}(origin)?-1===allowedOrigins.indexOf(origin)&&(frames.removePostMessageOrigin(".*"),allowedOrigins.push(origin),re_postMessageAllowedOrigin=compileOriginRegExp(allowedOrigins)):allowedOrigins=[".*"]},removePostMessageOrigin:function(origin){var index=allowedOrigins.indexOf(origin);-1!==index&&(allowedOrigins.splice(index,1),re_postMessageAllowedOrigin=compileOriginRegExp(allowedOrigins))},listen:function(namespace){-1===messageNamespaces.indexOf(namespace)&&(messageNamespaces.push(namespace),re_messageNamespaces=compileNamespaceRegExp(messageNamespaces)),listening||(_addEventListener("message",receiveMessage),listening=!0)},stopListening:function(namespace){var index=messageNamespaces.indexOf(namespace);-1!==index&&(messageNamespaces.splice(index,1),messageNamespaces.length?re_messageNamespaces=compileNamespaceRegExp(messageNamespaces):(_removeEventListener("message",receiveMessage),listening=!1))}}}(this.r=this.r||{},this),function(App,r){Object.prototype.hasOwnProperty;App.utils=App.utils||{},App.utils.uuid=r.uuid,App.utils.serialize=function(obj){var params=[];for(var p in obj)obj.hasOwnProperty(p)&&params.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return params.join("&")}}(window.rembeddit=window.rembeddit||{},r),function(App){(App.PixelTracker=function(options){this._pixelTrackingUrl=options.url,this._anonymousPixelTrackingUrl=options.anonymousUrl}).prototype.send=function(payload,options,callback){"function"==typeof options&&(callback=options,options={}),callback=callback||function(){};var url=(options=options||{}).anonymous?this._anonymousPixelTrackingUrl:this._pixelTrackingUrl;if(payload&&url){payload.uuid=payload.uuid||App.utils.uuid();var image=new Image,buster=Math.round(2147483647*Math.random());image.onload=callback,image.src=url+"?r="+buster+"&data="+encodeURIComponent(JSON.stringify(payload))}else callback()}}(window.rembeddit=window.rembeddit||{}),function(App){var RE_ABS=/^https?:\/\//i,RE_COMMENT=new RegExp("\\/?"+r.config.brander_community_abbr+"/[\\w_]+/comments/(?:\\S+/){2,}[\\w_]+/?","i"),PROTOCOL="file:"===location.protocol?"https:":"";function getCommentPathname(anchor){return function(anchor){return RE_ABS.test(anchor.href)&&RE_COMMENT.test(anchor.pathname)}(anchor)&&anchor.pathname.replace(/^\//,"")}App.init=function(options,callback){options=options||{},callback=callback||function(){};var embeds=document.querySelectorAll(".reddit-embed");[].forEach.call(embeds,function(embed){if(!embed.getAttribute("data-initialized")){embed.setAttribute("data-initialized",!0);var iframe=document.createElement("iframe"),commentUrl=function(links,host){for(var pathname,i=0,l=links.length;i<l&&!(pathname=getCommentPathname(links[i]));i++);return"//"+host+"/"+pathname}(embed.getElementsByTagName("a"),embed.getAttribute("data-embed-media"));if(commentUrl){r.frames.addPostMessageOrigin(embed.getAttribute("data-embed-media")),r.frames.listen("embed"),iframe.height=iframe.style.height=0,iframe.width=iframe.style.width="100%",iframe.scrolling="no",iframe.frameBorder=0,iframe.allowTransparency=!0,iframe.style.display="none",iframe.style.maxWidth="800px",iframe.style.minWidth="220px",iframe.style.margin="10px 0",iframe.style.borderRadius="5px",iframe.style.boxShadow="0 0 5px 0.5px rgba(0, 0, 0, 0.05)",iframe.style.borderColor="rgba(199,199,199, 0.55)",iframe.style.borderWidth="1px",iframe.style.borderStyle="solid",iframe.style.boxSizing="border-box",iframe.src=function(commentUrl,el){var context=0,showedits=el.getAttribute("data-embed-live");"true"===el.getAttribute("data-embed-parent")&&context++;var query="embed=true&context="+context+"&depth="+ ++context+"&showedits="+("true"===showedits)+"&created="+el.getAttribute("data-embed-created")+"&showmore=false";return PROTOCOL+commentUrl.replace(/\/$/,"")+"?"+query}(commentUrl,embed),r.frames.receiveMessageOnce(iframe,"ping.embed",function(e){embed.parentNode.removeChild(embed),iframe.style.display="block",callback(e),r.frames.postMessage(iframe.contentWindow,"pong.embed",{type:"true"===embed.getAttribute("data-embed-parent")?"comment_and_parent":"comment",location:location,options:options})});var resizer=r.frames.receiveMessage(iframe,"resize.embed",function(e){iframe.parentNode?iframe.height=iframe.style.height=e.detail+"px":resizer.off()});embed.parentNode.insertBefore(iframe,embed)}}})},App.preview||App.init()}(window.rembeddit=window.rembeddit||{},window.r),function(r){var jail=document.getElementById("gtm-jail");r.gtm={trigger:function(eventName,payload){payload&&this.set(payload),r.frames.postMessage(jail.contentWindow,"event.gtm",{event:eventName})},set:function(data){r.frames.postMessage(jail.contentWindow,"data.gtm",data)}}}(this.r=this.r||{}),function(r){r.sync=function(method,model,options){var wrappedDataFilter=options.dataFilter;return options.dataFilter=function(data,type){var filteredData;return filteredData="json"===type?r.utils.unescapeJson(data):data,wrappedDataFilter?wrappedDataFilter(filteredData):filteredData},r.backboneSync.call(Backbone,method,model,options)},r.setupBackbone=function(){Backbone.emulateJSON=!0,Backbone.ajax=r.ajax,r.backboneSync||(r.backboneSync=Backbone.sync,Backbone.sync=r.sync)}}(r),function(r,Backbone,_){"use strict";var Timing=Backbone.Model.extend({duration:function(){return this.get("end")-this.get("start")},isValid:function(){return 0!==this.get("end")}}),Timings=Backbone.Collection.extend({model:Timing,comparator:"start",initialize:function(){this.on("reset",this.calculate,this)},calculate:function(){this.startTime=this.min(function(timing){return timing.get("start")}).get("start"),this.endTime=this.max(function(timing){return timing.get("end")}).get("end"),this.duration=this.endTime-this.startTime}}),NavigationTimings=Timings.extend({fetch:function(){if(window.performance&&window.performance.timing){var pt=window.performance.timing,timings=[];timing("redirect","redirectStart","redirectEnd"),timing("start","fetchStart","domainLookupStart"),timing("dns","domainLookupStart","domainLookupEnd"),timing("tcp","connectStart","connectEnd"),timing("https","secureConnectionStart","connectEnd"),timing("request","requestStart","responseStart"),timing("response","responseStart","responseEnd"),timing("domLoading","domLoading","domInteractive"),timing("domInteractive","domInteractive","domContentLoadedEventStart"),timing("domContentLoaded","domContentLoadedEventStart","domContentLoadedEventEnd"),this.reset(_.values(timings))}function timing(key,start,end){pt[start]&&pt[end]&&timings.push({key:key,start:pt[start]/1e3,end:pt[end]/1e3})}}});r.NavigationTimings=NavigationTimings,r.Timing=Timing,r.Timings=Timings}(r,Backbone,_),r.templating={},r.templating.TemplateSet=function(){this.index={}},r.templating.TemplateSet.prototype={_templateSettings:{variable:"thing"},_key:function(name,style){return name+"."+style},_create:function(templateData){return _.template(templateData,null,this._templateSettings)},set:function(templates){_.each(templates,function(tplInfo){r.config.uncompressedJS&&(tplInfo=r.utils.unescapeJson(tplInfo));var key=this._key(tplInfo.name,tplInfo.style);this.index[key]=tplInfo.template},this)},_defaultStyle:function(nameAndStyle){return _.isArray(nameAndStyle)||(nameAndStyle=[nameAndStyle,r.config.renderstyle]),nameAndStyle},get:function(nameAndStyle){nameAndStyle=this._defaultStyle(nameAndStyle);var key=this._key(nameAndStyle[0],nameAndStyle[1]);if(!this.index[key])throw'"'+nameAndStyle[0]+"."+nameAndStyle[1]+'" template not found.';return template=this.index[key],_.isFunction(template)||(template=this.index[key]=this._create(template)),template},make:function(nameAndStyle,data,parentEl){return html=this.get(nameAndStyle)(data),parentEl&&$(parentEl).append(html),html}},r.templates=new r.templating.TemplateSet,function(r,$){r.ScrollUpdater=Backbone.View.extend({selector:null,startUpdate:function(){},update:function($el){},endUpdate:function($els){},start:function(){return this._resetScrollState(),this._listen(),this},restart:function(){return this._resetScrollState(),this},_resetScrollState:function(){this._elements=this.$el.find(this.selector),_.sortBy(this._elements,function(el){return $(el).offset().top}),this._curIndex=0,this._lastScroll=null,this._toUpdate=[],this._totalTime=0,_.defer($.proxy(this,"_updateThings"))},_listen:function(){var throttledUpdate=_.throttle($.proxy(this,"_updateThings"),20);$(window).on("scroll",throttledUpdate)},_updateThings:function(ev){if(this._elements.length){var startTime=new Date,$win=$(window),winHeight=$win.height(),scrollTop=$win.scrollTop(),ceiling=scrollTop,floor=scrollTop+winHeight;scrollTop<this._lastScroll?ceiling=Math.max(ceiling-Math.floor(winHeight/2),0):floor+=Math.ceil(winHeight/2);var idx=this._curIndex,$cur=$(this._elements[idx]);if($cur.offset().top<ceiling)for(;idx<this._elements.length-1&&$cur.offset().top<ceiling;)$cur=$(this._elements[idx]),idx++;else for(;0<idx&&$cur.offset().top>ceiling;)$cur=$(this._elements[idx]),idx--;for(;$cur=$(this._elements[idx]),this._toUpdate.push($cur),0,++idx<=this._elements.length-1&&$cur.offset().top<=floor;);this._curIndex=idx-1,this._lastScroll=scrollTop;var endTime=new Date;this._totalTime+=endTime-startTime,this._doUpdates()}},cutoff:1e3/60,_doUpdates:function(){this.startUpdate();for(var startTime=new Date,endTime=startTime,els=[];endTime-startTime<this.cutoff&&this._toUpdate.length;){var $el=this._toUpdate.shift();els.push($el),this.update($el),0,endTime=new Date}this._totalTime+=endTime-startTime,this._toUpdate.length&&_.defer($.proxy(this,"_doUpdates")),this.endUpdate($(els))}})}(r,jQuery),function(r,$){Date.now||(Date.now=function(){return(new Date).getTime()});var clientTimeInit=Date.now(),CHUNKS=[[31536e3,r.NP_("a year ago","%(num)s years ago")],[2592e3,r.NP_("a month ago","%(num)s months ago")],[86400,r.NP_("a day ago","%(num)s days ago")],[3600,r.NP_("an hour ago","%(num)s hours ago")],[60,r.NP_("a minute ago","%(num)s minutes ago")]],defaults={maxage:86400};function TimeText(opts){this.opts=_.defaults(opts||{},defaults),this.elCache=$([]),this.refresh=_.throttle(this._refresh,1e3),setInterval($.proxy(this.refresh,this),2e4),this.refresh()}TimeText.prototype._refresh=function(){var now=TimeText.now();this.elCache.each($.proxy(function(i,el){this.refreshOne(el,now)},this))},TimeText.prototype.updateCache=function(elCache){this.elCache=elCache,this.refresh()},TimeText.prototype.refreshOne=function(el,now){now=now||TimeText.now();var text,age,$el=$(el),timestamp=r.utils.parseTimestamp($el);age=(now-timestamp)/1e3,!1!==this.opts.maxage&&age>this.opts.maxage?$el.removeClass("live-timestamp"):(text=this.formatTime($el,age,timestamp,now),$el.text(text))},TimeText.prototype.formatTime=function($el,age,timestamp,now){var text=r._("just now");return $.each(CHUNKS,function(ix,chunk){var keys,count=Math.floor(age/chunk[0]);if(0<count)return keys=chunk[1],text=r.P_(keys[0],keys[1],count).format({num:count}),!1}),text},TimeText.clientOffset=0,TimeText.now=function(){return Date.now()-TimeText.clientOffset},TimeText.init=function(){var serverTimeInit=1e3*r.config.server_time,delta=clientTimeInit-serverTimeInit,clientHourOffset=Math.round(delta/36e5);this.clientOffset=36e5*clientHourOffset},r.TimeText=TimeText}(r,jQuery),r.ui.init=function(){$.cookie("reddit_first")?($.cookie("reddit_first",null,{domain:r.config.cur_domain}),store.safeSet("ui.shown.welcome",!0)):1!=store.safeGet("ui.shown.welcome")&&($(".infobar.welcome").show(),store.safeSet("ui.shown.welcome",!0));$.url().attr("path");$(".help-bubble").each(function(idx,el){$(el).data("HelpBubble",new r.ui.Bubble({el:el}))}),$(".submit_text").each(function(idx,el){$(el).data("SubredditSubmitText",new r.ui.SubredditSubmitText({el:el}))}),r.config.new_window&&(r.config.logged,1)&&$(document.body).on("click","a.may-blank, .may-blank-within a",function(e){if(!this.target){var isWebLink=_.contains(["http:","https:"],this.protocol);if(this.href&&isWebLink&&r.utils.onTrident()){var w=window.open(this.href,"_blank");if(null!==w)return w.opener=null,e.preventDefault(),!1}this.target="_blank",this.rel="noreferrer"}return!0}),r.ui.PermissionEditor.init(),r.ui.initLiveTimestamps(),r.ui.initNewCommentHighlighting(),r.ui.initReadNext(),r.ui.initTimings()},r.ui.inMobileWebBlacklist=function(){return _.any(r.config.mweb_blacklist_expressions,function(regex){return new RegExp(regex).test(window.location.pathname)})},r.ui.isSmallScreen=function(){return window.matchMedia?matchMedia("(max-device-width: 736px)").matches:$(window).width()<736},r.ui.TimeTextScrollListener=r.ScrollUpdater.extend({initialize:function(options){this.timeText=options.timeText,this.timeText.updateCache($(this.selector))},selector:".live-timestamp:visible",endUpdate:function($els){this.timeText.updateCache($els)}}),r.ui.initLiveTimestamps=function(){if($(".sitetable").length){var listener=new r.ui.TimeTextScrollListener({el:".sitetable",timeText:new r.TimeText});listener.start(),$(document).on("new_things_inserted",function(){listener.restart()})}},r.ui.initNewCommentHighlighting=function(){$("body").hasClass("comments-page")&&($visitSelector=$("#comment-visits"),0!==$visitSelector.length&&($(document).on("new_things_inserted",r.ui.highlightNewComments),$visitSelector.on("change",r.ui.highlightNewComments),r.ui.highlightNewComments()))},r.ui.highlightNewComments=function(){var selectedVisit,$comments=$(".comment"),selectedVisitTimestamp=$("#comment-visits").val();selectedVisitTimestamp&&(selectedVisit=Date.parse(selectedVisitTimestamp)),$comments.each(function(){var $commentEl=$(this),$timeEl=$commentEl.find("> .entry .tagline time:first-of-type"),commentTime=r.utils.parseTimestamp($timeEl),shouldHighlight=!!selectedVisit&&selectedVisit<commentTime;$commentEl.toggleClass("new-comment",shouldHighlight)})},r.ui.initReadNext=function(){var $readNextContainer=$(".read-next-container"),isDismissed=!!store.safeGet("readnext.dismissed"),expiration=parseInt(store.safeGet("readnext.expiration"),10),now=Date.now();isDismissed&&(expiration?expiration<now&&(store.safeSet("readnext.dismissed",!1),isDismissed=!1):(expiration=now+12096e5,store.safeSet("readnext.expiration",expiration)));var currentLinkFullname=r.config.cur_link;!isDismissed&&$readNextContainer.length&&(this.readNext=new r.ui.ReadNext({el:$readNextContainer,fixToBottom:1,currentLinkFullname:currentLinkFullname,ttl:12096e5}))},r.ui.ReadNext=Backbone.View.extend({events:{"click .read-next-button.next":"next","click .read-next-button.prev":"prev","click .read-next-dismiss":"dismiss"},initialize:function(){this.$readNext=this.$el.find(".read-next"),this.$links=this.$readNext.find(".read-next-link"),this.numLinks=this.$links.length,this.state=new Backbone.Model({fixed:!1,index:-1}),this.state.on("change",this.render.bind(this)),this.options.fixToBottom&&(this.updateScroll=this.updateScroll.bind(this),window.addEventListener("scroll",this.updateScroll),this.updateScroll());var currentLinkId="#read-next-link-"+this.options.currentLinkFullname,startingIndex=this.$links.index($(currentLinkId))+1;this.state.set({index:startingIndex}),this.resetRefIndicies(startingIndex),this.$readNext.addClass("active")},resetRefIndicies:function(startingIndex){var a=document.createElement("a");this.$links.toArray().forEach(function(link,i){var params=$.url(link.href).param();if(params.ref){var relativeIndex=this.moduloIndex(i-startingIndex);params.ref=params.ref.split("_")[0]+"_"+relativeIndex,a.href=link.href,a.search=$.param(params),link.href=a.href}},this)},moduloIndex:function(i){var numLinks=this.numLinks;return(i+numLinks)%numLinks},next:function(){var currentIndex=this.state.get("index");this.state.set({index:this.moduloIndex(currentIndex+1)}),r.analytics.fireGAEvent("readnext","nav-next")},prev:function(){var currentIndex=this.state.get("index");this.numLinks;this.state.set({index:this.moduloIndex(currentIndex-1)}),r.analytics.fireGAEvent("readnext","nav-prev")},dismiss:function(){this.$el.fadeOut(),window.removeEventListener("scroll",this.updateScroll),r.analytics.fireGAEvent("readnext","dismiss"),store.safeSet("readnext.dismissed",!0);var expiration=Date.now()+this.options.ttl;store.safeSet("readnext.expiration",expiration)},updateScroll:function(){var scrollPosition=window.scrollY,nodePosition=this.$el.position().top;scrollPosition+=window.innerHeight,nodePosition+=this.$readNext.height(),this.state.set({fixed:nodePosition<=scrollPosition})},render:function(){var currentIndex=this.state.get("index"),fixedPosition=this.state.get("fixed");this.$links.removeClass("active"),this.$links.eq(currentIndex).addClass("active"),fixedPosition?this.$readNext.addClass("fixed"):this.$readNext.removeClass("fixed")}}),r.ui.initTimings=function(){if(r.config.pageInfo.actionName&&r.config.stats_domain&&!(Math.random()>r.config.stats_sample_rate/100)){var browserTimings=new r.NavigationTimings;$(function(){_.defer(function(){browserTimings.fetch();var timingData=browserTimings.filter(function(t){return"start"!==t.get("key")}).reduce(function(o,t){if(!t.isValid())return o;var val=t.duration();0<val&&(o[t.get("key")+"Timing"]=val);return o},{});timingData.actionName=r.config.pageInfo.actionName,timingData.verification=r.config.pageInfo.verification,$.ajax({type:"POST",url:r.config.stats_domain,data:JSON.stringify({rum:timingData}),contentType:"application/json; charset=utf-8",dataType:"json"})})})}},r.ui.showWorkingDeferred=function(el,deferred){if(deferred){var key="_workingCount",$el=$(el);$el.data(key,($el.data(key)||0)+1);var flickerTimeout=setTimeout(function(){$el.addClass("working")},200);return deferred.always(function(){clearTimeout(flickerTimeout);var count=Math.max(0,$el.data(key)-1);$el.data(key,count),0==count&&$el.removeClass("working")}),deferred}},r.ui.refreshListing=function(){var url=$.url(),params=url.param();return params.bare="y",$.ajax({type:"GET",url:url.attr("base")+url.attr("path"),data:params}).done(function(resp){$("body > .content").html(resp).find(".promotedlink.promoted:visible").trigger("onshow")})},r.ui.Form=function(el){r.ui.Base.call(this,el),this.$el.submit($.proxy(function(e){e.preventDefault(),this.submit(e)},this)),this.$el.find("[data-validate-url]").validator({https:!!r.config.https_endpoint}).on("initialize.validator",function(e){var $el=$(this);$el.hasClass("c-has-error")&&$el.stateify("showError")}).on("valid.validator",function(e){$(this).stateify("set","success")}).on("invalid.validator",function(e,resp){if(resp){var error=r.utils.parseError(resp.errors[0]);$(this).stateify("set","error",error.message)}}).on("loading.validator",function(e){$(this).stateify("set","loading")}).on("cleared.validator",function(e){$(this).stateify("clear")})},r.ui.Form.prototype=$.extend(new r.ui.Base,{showStatus:function(msg,isError){this.$el.find(".status, .c-alert").show().toggleClass("error",!!isError).text(msg)},showErrors:function(errors){var messages=[];$.each(errors,$.proxy(function(i,err){var obj=r.utils.parseError(err),$el=this.$el.find(".error."+obj.name+(obj.field?".field-"+obj.field:"")),$v2el=this.$el.filter(".form-v2").find('[name="'+obj.field+'"]');$el.length?$el.show().text(obj.message):$v2el.length?$v2el.stateify("set","error",obj.message):messages.push(obj.message)},this)),messages.length&&this.showStatus(messages.join(", "),!0)},resetErrors:function(){this.$el.find(".error").hide()},checkCaptcha:function(errors){this.$el.has('input[name="captcha"]').length&&$.grep(errors,function(el){return"badCaptcha"==el[0]})&&$.request("new_captcha",{id:this.$el.attr("id")})},serialize:function(){return this.$el.serializeArray()},submit:function(){this.resetErrors(),r.ui.showWorkingDeferred(this.$el,this._submit()).done($.proxy(this,"handleResult")).fail($.proxy(this,"_handleNetError"))},_submit:function(){},handleResult:function(result){this.checkCaptcha(result.json.errors),this._handleResult(result)},_handleResult:function(result){this.showErrors(result.json.errors)},_handleNetError:function(xhr){var message=r._("an error occurred (status: %(status)s)").format({status:xhr.status});this.showStatus(message,!0)}}),r.ui.Bubble=Backbone.View.extend({showDelay:150,hideDelay:750,animateDuration:150,initialize:function(){this.$parent=this.options.parent||this.$el.parent(),0!=this.options.trackHover&&(this.$el.hover($.proxy(this,"queueShow"),$.proxy(this,"queueHide")),this.$parent.hover($.proxy(this,"queueShow"),$.proxy(this,"queueHide")),this.$parent.click($.proxy(this,"queueShow")))},position:function(){var offsetX,offsetY,parentPos=this.$parent.offset(),bodyOffset=$("body").offset();this.$el.is(".anchor-top")||this.$el.is(".anchor-top-centered")?(offsetX=this.$parent.outerWidth(!0)-this.$el.outerWidth(!0),offsetY=this.$parent.outerHeight(!0)+5,this.$el.css({left:Math.max(parentPos.left+offsetX,0),top:parentPos.top+offsetY-bodyOffset.top})):this.$el.is(".anchor-top-left")?(offsetY=this.$parent.outerHeight(!0)+5,this.$el.css({left:parentPos.left,top:parentPos.top+offsetY-bodyOffset.top})):this.$el.is(".anchor-right-fixed")?(offsetX=32,offsetY=0,parentPos.top-=$(document).scrollTop(),parentPos.left-=$(document).scrollLeft(),this.$el.css({top:r.utils.clamp(parentPos.top-offsetY,0,$(window).height()-this.$el.outerHeight()),left:r.utils.clamp(parentPos.left-offsetX-this.$el.width(),0,$(window).width())})):this.$el.is(".anchor-left")?(offsetX=this.$parent.outerWidth(!0)+16,offsetY=0,this.$el.css({left:parentPos.left+offsetX,top:parentPos.top+offsetY-bodyOffset.top})):(offsetX=16,offsetY=0,parentPos.right=$(window).width()-parentPos.left,this.$el.css({right:parentPos.right+offsetX,top:parentPos.top+offsetY-bodyOffset.top}))},show:function(){this.cancelTimeout(),this.$el.is(":visible")||(this.trigger("show"),$("body").append(this.$el),this.$el.css("visibility","hidden").show(),this.render(),this.position(),this.$el.css({opacity:1,visibility:"visible"}),this.options.group&&this.options.group.current&&this.options.group.current!=this?this.options.group.current.hideNow():this._animate("show"),this.options.group&&(this.options.group.current=this))},hideNow:function(){this.cancelTimeout(),this.options.group&&this.options.group.current==this&&(this.options.group.current=null),this.$el.hide()},hide:function(callback){this.$el.is(":visible")?this._animate("hide",$.proxy(function(){this.hideNow(),callback&&callback()},this)):callback&&callback()},_animate:function(action,callback){if(this.animateDuration){var animProp,animOffset;animOffset=this.$el.is(".anchor-top")||this.$el.is(".anchor-top-centered")||this.$el.is(".anchor-top-left")?(animProp="top","-=5"):this.$el.is(".anchor-right-fixed")?(animProp="right","-=5"):this.$el.is(".anchor-left")?(animProp="left","+=5"):(animProp="right","-=5");var start,end,curOffset=this.$el.css(animProp);hideProps={opacity:0},hideProps[animProp]=animOffset,showProps={opacity:1},showProps[animProp]=curOffset,"show"==action?(start=hideProps,end=showProps):"hide"==action&&(start=showProps,end=hideProps),this.$el.css(start).animate(end,this.animateDuration,callback)}else callback&&callback()},cancelTimeout:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)},queueShow:function(){this.cancelTimeout(),this.timeout=setTimeout($.proxy(this,"show"),this.showDelay)},queueHide:function(){this.cancelTimeout(),this.timeout=setTimeout($.proxy(this,"hide"),this.hideDelay)}}),r.ui.PermissionEditor=function(el){r.ui.Base.call(this,el);var params={};this.$el.find('input[type="hidden"]').each(function(idx,el){params[el.name]=el.value});var permission_type=params.type,name=params.name;this.form_id=permission_type+"-permissions-"+name,this.permission_info=r.permissions[permission_type],this.sorted_perm_keys=$.map(this.permission_info,function(v,k){return k}),this.sorted_perm_keys.sort(),this.original_perms=this._parsePerms(params.permissions),this.embedded=0==this.$el.find("form").length,this.$menu=null,this.embedded?(this.$permissions_field=this.$el.find('input[name="permissions"]'),this.$menu_controller=this.$el.siblings(".permissions-edit")):this.$menu_controller=this.$el.closest("tr").find(".permissions-edit"),this.$menu_controller.find("a").click($.proxy(this,"show")),this.updateSummary()},r.ui.PermissionEditor.init=function(){function activate(target){$(target).find(".permissions").each(function(idx,el){$(el).data("PermissionEditor",new r.ui.PermissionEditor(el))})}for(var permission_type in activate("body"),r.permissions)$("."+permission_type+"-table").on("insert-row","tr",function(e){activate(this)})},r.ui.PermissionEditor.prototype=$.extend(new r.ui.Base,{_parsePerms:function(permspec){var perms={};return permspec.split(",").forEach(function(str){perms[str.substring(1)]="+"==str[0]}),perms.all?{all:!0}:perms},_serializePerms:function(perms){if(perms.all)return"+all";var parts=[];for(var perm in perms)parts.push((perms[perm]?"+":"-")+perm);return parts.join(",")},_getNewPerms:function(){if(!this.$menu)return null;var perms={};return this.$menu.find('input[type="checkbox"]').each(function(idx,el){perms[$(el).attr("name")]=$(el).prop("checked")}),perms},_makeMenuLabel:function(perm){var update=$.proxy(this,"updateSummary"),info=this.permission_info[perm],$input=$('<input type="checkbox">').attr("name",perm).prop("checked",this.original_perms[perm]),$label=$("<label>").append($input).click(function(e){e.stopPropagation()});return"all"==perm?($input.change(function(){var disabled=$input.is(":checked");$label.siblings().toggleClass("disabled",disabled).find('input[type="checkbox"]').prop("disabled",disabled),update()}),$label.append(document.createTextNode(r._("full permissions")))):info&&($input.change(update),$label.append(document.createTextNode(r._(info.title))),$label.attr("title",r._(info.description))),$label},show:function(e){if(!r.access.isLinkRestricted(e.target)){for(var i in close_menus(e),this.$menu=$('<div class="permission-selector drop-choices">'),this.$menu.append(this._makeMenuLabel("all")),this.sorted_perm_keys)this.$menu.append(this._makeMenuLabel(this.sorted_perm_keys[i]));if(this.$menu.on("close_menu",$.proxy(this,"hide")).find("input").first().change().end(),!this.embedded){var $form=this.$el.find("form").clone();$form.attr("id",this.form_id),$form.click(function(e){e.stopPropagation()}),this.$menu.append("<hr>",$form),this.$permissions_field=this.$menu.find('input[name="permissions"]')}return this.$menu_controller.parent().append(this.$menu),open_menu(this.$menu_controller[0]),!1}},hide:function(){this.$menu&&(this.embedded&&(this.original_perms=this._getNewPerms(),this.$permissions_field.val(this._serializePerms(this.original_perms))),this.$menu.remove(),this.$menu=null,this.updateSummary())},_renderBit:function(perm){var text,info=this.permission_info[perm];text="all"==perm?r._("full permissions"):info?r._(info.title):perm;var $span=$('<span class="permission-bit"/>').text(text);return info&&$span.attr("title",r._(info.description)),$span},updateSummary:function(){var new_perms=this._getNewPerms(),spans=[];if(new_perms&&new_perms.all)spans.push(this._renderBit("all").toggleClass("added",1!=this.original_perms.all));else{if(this.original_perms.all&&!new_perms)spans.push(this._renderBit("all"));else if(!this.original_perms.all)for(var perm in this.original_perms)this.original_perms[perm]&&(!this.embedded||new_perms&&!new_perms[perm]||spans.push(this._renderBit(perm)),this.embedded||spans.push(this._renderBit(perm).toggleClass("removed",null!=new_perms&&!new_perms[perm])));if(new_perms)for(var perm in new_perms)this.permission_info[perm]&&new_perms[perm]&&!this.original_perms[perm]&&spans.push(this._renderBit(perm).toggleClass("added",!this.embedded))}spans.length||spans.push($('<span class="permission-bit">').text(r._("no permissions")).addClass("none"));for(var $new_summary=$('<div class="permission-summary">'),i=0;i<spans.length;i++)0<i&&$new_summary.append(", "),$new_summary.append(spans[i]);$new_summary.toggleClass("edited",null!=this.$menu),this.$el.find(".permission-summary").replaceWith($new_summary),new_perms&&this.$permissions_field&&this.$permissions_field.val(this._serializePerms(new_perms))},onCommit:function(perms){this.$el.find('input[name="permissions"]').val(perms),this.original_perms=this._parsePerms(perms),this.hide()}}),r.ui.scrollFixed=function(el){this.$el=$(el),this.$standin=null,this.onScroll(),$(window).bind("scroll resize",_.bind(_.throttle(this.onScroll,20),this))},r.ui.scrollFixed.prototype={onScroll:function(){if(!this.$el.is(".scroll-fixed")){var margin=this.$el.outerHeight(!0)-this.$el.outerHeight(!1);this.origTop=this.$el.offset().top-margin}this.$el.height()<$(window).height()&&$(window).scrollTop()>this.origTop?this.$standin||(this.$standin=$("<"+this.$el.prop("nodeName")+">").css({width:this.$el.width(),height:this.$el.height()}).attr("class",this.$el.attr("class")).addClass("scroll-fixed-standin"),this.$el.addClass("scroll-fixed").css({position:"fixed",top:0}),this.$el.before(this.$standin)):this.$standin&&(this.$el.removeClass("scroll-fixed").css({position:"",top:""}),this.$standin.remove(),this.$standin=null)}},r.ui.ConfirmButton=Backbone.View.extend({confirmTemplate:_.template('<span class="confirmation"><span class="prompt"><%- are_you_sure %></span><button class="yes"><%- yes %></button> / <button class="no"><%- no %></button></div>'),events:{click:"click"},initialize:function(){this.$target=this.$el,this.$target.wrap("<span>"),this.setElement(this.$target.parent()),this.$el.attr("class",this.$target.attr("class")).addClass("confirm-button"),this.$target.attr("class",null)},click:function(ev){var target=$(ev.target);this.$target.is(target)?(this.$target.hide(),this.$el.append(this.confirmTemplate({are_you_sure:r._("are you sure?"),yes:r._("yes"),no:r._("no")}))):target.is(".no")?(this.$(".confirmation").remove(),this.$target.show()):target.is(".yes")&&this.$target.trigger("confirm")}}),r.ui.SubredditSubmitText=Backbone.View.extend({initialize:function(){this.lookup=_.throttle(this._lookup,500),this.cache=new r.utils.LRUCache,this.$input=$("#sr-autocomplete"),this.$input.on("sr-changed change input",_.bind(this.lookup,this)),this.$sr=this.$el.find(".sr").first(),this.$content=this.$el.find(".content").first(),this.$content.text().trim()&&(this.$sr.text(r.config.post_site),this.show())},_lookup:function(){this.$content.empty();var sr=this.$input.val();this.$sr.text(sr),this.$el.addClass("working"),this.req&&this.req.abort&&this.req.abort(),this.req=this.cache.ajax(sr,{url:"/"+r.config.brander_community_abbr+"/"+sr+"/api/submit_text/.json",dataType:"json"}).done(_.bind(this.settext,this,sr)).fail(_.bind(this.error,this))},show:function(){this.$el.addClass("enabled")},hide:function(){this.$el.removeClass("enabled")},error:function(){delete this.req,this.hide()},settext:function(sr,data){delete this.req,data.submit_text&&data.submit_text.trim()?(this.$sr.text(sr),this.$content.html($.unsafe(data.submit_text_html)),this.$el.removeClass("working"),this.show()):this.hide()}}),r.ui.TextCounter=Backbone.View.extend({events:{"input input":"onInput","input textarea":"onInput"},initialize:function(options){this.error=!1,this.maxLength=options.maxLength,this.$counterDisplay=this.$el.find(".text-counter-display"),this.$counterParent=this.$counterDisplay.parent(),this.$input=this.$el.find(".text-counter-input"),this.update(options.initialText||"")},onInput:function(e){this.update(e.target.value)},update:function(inputText){var remaining=this.maxLength-inputText.length;this.$counterDisplay.text(remaining),remaining<0&&!this.error?(this.$counterParent.addClass("has-error"),this.error=!0,this.trigger("invalid")):0<=remaining&&this.error&&(this.$counterParent.removeClass("has-error"),this.error=!1,this.trigger("valid"))}}),function(ui,$,_){var SIZE_CLASS_LOOKUP={large:"modal-dialog-lg",medium:"",small:"modal-dialog-sm"},DEFAULTS={template:template,animate:!0,close:!0,modal:!0,shortcuts:!0,footer:!1,content:"",className:"",title:!1,size:"medium"},template=_.template('<div class="modal <% if (animate) { %> fade <% } %> <%- className %>"><div class="modal-dialog <% if (size) { %><%- SIZE_CLASS_LOOKUP[size] %><% } %>"><div class="modal-content"><% if (title || close) { %><div class="modal-header"><% if (close) { %><a href="javascript: void 0;" class="c-close c-hide-text" data-dismiss="modal">'+_.escape(r._("close this window"))+'</a><% } %><% if (title) { %><%= title %><% } %></div><% } %><div class="modal-body"><%= content %></div><% if (footer) { %><div class="modal-footer"><%= footer %></div><% } %></div></div></div>'),Popup=ui.Popup=function(options){options=_.extend({},DEFAULTS,options,{SIZE_CLASS_LOOKUP:SIZE_CLASS_LOOKUP});var html=template(options),listener=this.listener=$({}),$el=this.$=$(html);$el.modal({show:!1,backdrop:!!options.modal,keyboard:options.shortcuts}),[["show.bs.modal","show.r.popup"],["shown.bs.modal","opened.r.popup"],["hide.bs.modal","hide.r.popup"],["hidden.bs.modal","closed.r.popup"]].forEach(function(tuple){$el.on(tuple[0],function(){listener.trigger(tuple[1])})}),$el.attr("tabindex",$el.attr("tabindex")||0)};["show","hide","toggle"].forEach(function(fn){Popup.prototype[fn]=function(){this.$.modal(fn)}}),[["on","on"],["once","one"],["off","off"]].forEach(function(tuple){Popup.prototype[tuple[0]]=function(){this.listener[tuple[1]].apply(this.listener,arguments)}})}((this.r=this.r||{})&&(r.ui=r.ui||{}),this.jQuery,this._),r.login={post:function(form,action){var username=$('input[name="user"]',form.$el).val(),endpoint=r.config.https_endpoint||"http://"+r.config.ajax_domain,apiTarget=endpoint+"/api/"+action+"/"+username;if(r.config.currentOrigin==endpoint||$.support.cors){var params=form.serialize();return params.push({name:"api_type",value:"json"}),$.ajax({url:apiTarget,type:"POST",dataType:"json",data:params,xhrFields:{withCredentials:!0}})}var iframe=$("<iframe>"),postForm=form.$el.clone(!0),frameName=("resp"+Math.random()).replace(".","");iframe.css("display","none").attr("name",frameName).appendTo("body"),iframe[0].contentWindow.name=frameName,postForm.unbind().css("display","none").attr("action",apiTarget).attr("target",frameName).appendTo("body"),$("<input>").attr({type:"hidden",name:"api_type",value:"json"}).appendTo(postForm),$("<input>").attr({type:"hidden",name:"hoist",value:r.login.hoist.type}).appendTo(postForm);var deferred=r.login.hoist.watch(action);return r.config.debug||deferred.done(function(){iframe.remove(),postForm.remove()}),postForm.submit(),deferred}},r.login.hoist={type:"cookie",watch:function(name){var cookieName="hoist_"+name,deferred=new $.Deferred,interval=setInterval(function(){if(data=$.cookie(cookieName),data){try{data=JSON.parse(data)}catch(e){data=null}$.cookie(cookieName,null,{domain:r.config.cur_domain,path:"/"}),clearInterval(interval),deferred.resolve(data)}},100);return deferred}},r.login.ui={init:function(){r.config.logged||($(".content .login-form, .content #login-form, .side .login-form").each(function(i,el){new r.ui.LoginForm(el)}),$(".content .register-form, .content #register-form").each(function(i,el){new r.ui.RegisterForm(el)}),$("#login-popup").length?this.popup={}:this.popup=new r.ui.LoginPopup,$(document).delegate(".login-required","click",$.proxy(this,"loginRequiredAction")))},_getActionDetails:function(el){var $el=$(el);return $el.hasClass("up")?{eventName:"upvote",description:r._("You need to be logged in to vote on things.")}:$el.hasClass("down")?{eventName:"downvote",description:r._("You need to be logged in to vote on things.")}:$el.hasClass("arrow")?{eventName:"arrow",description:r._("You need to be logged in to vote on things.")}:$el.hasClass("give-gold")?{eventName:"give-gold",description:r._("You need to be logged in to give gold.")}:$el.parents("#header").length&&-1!==$el.attr("href").indexOf("login")?{eventName:"login-or-register"}:$el.parents(".subscribe-button").length?{eventName:"subscribe-button",description:r._("You need to be logged in to subscribe to subs.")}:$el.parents(".submit-link").length?{eventName:"submit-link",description:r._("You need to be logged in to submit things.")}:$el.parents(".submit-text").length?{eventName:"submit-text",description:r._("You need to be logged in to submit things.")}:{eventName:$el.attr("class"),description:r._("You need to be logged in to do that.")}},_logEvent:function(e){var target=$(e.target),thing=target.thing(),targetType=target.data("type")||thing.data("type"),targetFullname=target.data("fullname")||thing.data("fullname"),actionName=target.data("event-action"),actionDetail=target.data("event-detail");actionName||(actionName="modal",actionDetail=null),targetFullname||"subreddit"!=targetType?targetFullname||"link"!=targetType||(targetFullname=r.config.cur_link):targetFullname=r.config.cur_site,r.analytics.loginRequiredEvent(actionName,actionDetail,targetType,targetFullname)},loginRequiredAction:function(e){if(r.config.logged)return!0;if(r.config.feature_login_popup_disabled)return window.location=r.config.https_endpoint+"/login",!1;$("#login-popup").length&&(this.popup=new r.ui.LoginPopup);var dest,el=$(e.target),href=el.attr("href"),actionDetails=this._getActionDetails(el);if(href&&"#"!=href&&!/\/login\/?$/.test(href))dest=href;else{var thing=el.thing();thing.length&&(dest=thing.find(".comments").attr("href"))}return this.popup.showLogin(actionDetails.description,dest&&$.proxy(function(result){window.location=dest},this)),this._logEvent(e),r.analytics.fireGAEvent("login-required-popup","opened",actionDetails.eventName),!1}},r.ui.LoginForm=function(){r.ui.Form.apply(this,arguments)},r.ui.LoginForm.prototype=$.extend(new r.ui.Form,{showErrors:function(errors){r.ui.Form.prototype.showErrors.call(this,errors),errors.length&&this.$el.find(".recover-password").addClass("attention")},showStatus:function(){this.$el.find(".error").css("opacity",1),r.ui.Form.prototype.showStatus.apply(this,arguments)},resetErrors:function(){if(this.$el.hasClass("login-form-side")){var errorEl=this.$el.find(".error");errorEl.is(":visible")&&errorEl.fadeTo(100,.35)}else r.ui.Form.prototype.resetErrors.apply(this,arguments)},_submit:function(){return r.analytics.fireGAEvent("login-form","submit"),r.login.post(this,"login")},_handleResult:function(result){if(result.json.errors.length)r.ui.Form.prototype._handleResult.call(this,result);else if(this.successCallback)this.successCallback(result);else{this.$el.addClass("working");var base=r.config.extension?"/."+r.config.extension:"/",defaultDest=/\/login\/?$/.test($.url().attr("path"))?base:window.location,redir=this.$el.find('input[name="dest"]').val()||defaultDest;window.location===redir?window.location.reload():window.location=redir}},_handleNetError:function(xhr){r.ui.Form.prototype._handleNetError.apply(this,arguments),0==xhr.status&&r.config.currentOrigin!=r.config.https_endpoint&&$("<p>").append($("<a>").text(r._("try using our secure login form.")).attr("href",r.config.https_endpoint+"/login")).appendTo(this.$el.find(".status"))},focus:function(){this.$el.find('input[name="user"]').focus()}}),r.ui.RegisterForm=function(){r.ui.Form.apply(this,arguments),this.$user=this.$el.find('[name="user"]'),this.$user.is("[data-validate-url]")||(this.checkUsernameDebounced=_.debounce($.proxy(this,"checkUsername"),500),this.$user.on("keyup",$.proxy(this,"usernameChanged"))),this.$el.find('[name="passwd2"]').on("keyup",$.proxy(this,"checkPasswordMatch")),this.$el.find('[name="passwd"][data-validate-url]').strengthMeter({related:["#user_reg","#email_reg"],delay:0,trigger:"loaded.validator"}).on("score.strengthMeter",function(e,score){var message,$el=$(this);"error"!==$el.stateify("getCurrentState")&&(message=90<score?r._("Password is strong"):70<score?r._("Password is good"):30<score?r._("Password is fair"):r._("Password is weak"),$el.stateify("showMessage",message))}),this.$submit=this.$el.find(".submit button")},r.ui.RegisterForm.prototype=$.extend(new r.ui.Form,{maxName:0,usernameChanged:function(){var name=this.$user.val();name!=this._priorName&&(this._priorName=name,this.$el.find(".error.field-user").hide(),this.$el.removeClass("name-checking name-available name-taken"),this.maxName=Math.max(this.maxName,name.length),name&&3<=this.maxName&&(this.$el.addClass("name-checking"),this.checkUsernameDebounced()),this.$submit.attr("disabled",!1))},checkPasswordMatch:_.debounce(function(){var $confirm=this.$el.find('[name="passwd2"]'),$password=this.$el.find('[name="passwd"]'),confirm=$confirm.val(),password=$password.val();confirm&&"success"===$password.stateify("getCurrentState")?confirm===password?$confirm.stateify("set","success"):$confirm.stateify("set","error",r._("passwords do not match")):$confirm.stateify("clear")},$.fn.validator.Constructor.DEFAULTS.delay),checkUsername:function(){var name=this.$user.val();name?$.ajax({url:"/api/username_available.json",data:{user:name},success:$.proxy(this,"displayUsernameStatus"),complete:$.proxy(function(){this.$el.removeClass("name-checking")},this)}):this.$el.removeClass("name-available name-taken")},displayUsernameStatus:function(result){result.json&&result.json.errors?(this.showErrors(result.json.errors),this.$submit.attr("disabled",!0)):(this.$el.addClass(result?"name-available":"name-taken"),this.$submit.attr("disabled",0==result))},_submit:function(){return r.analytics.fireGAEvent("register-form","submit"),r.login.post(this,"register")},_handleResult:r.ui.LoginForm.prototype._handleResult,focus:r.ui.LoginForm.prototype.focus}),r.ui.LoginPopup=function(){var content=$("#login-popup").prop("innerHTML");r.ui.Popup.call(this,{size:"large",content:content,className:"login-modal"}),this.login=new r.ui.LoginForm(this.$.find("#login-form")),this.register=new r.ui.RegisterForm(this.$.find("#register-form"))},r.ui.LoginPopup.prototype=_.extend({},r.ui.Popup.prototype,{show:function(notice,callback){return this.login.successCallback=callback,this.register.successCallback=callback,this.$.find("#cover-msg").text(notice).toggle(!!notice),r.ui.Popup.prototype.show.call(this),!1},showLogin:function(){var login=this.login;this.show.apply(this,arguments),this.once("opened.r.popup",function(){login.focus()})},showRegister:function(){var register=this.register;this.show.apply(this,arguments),this.once("opened.r.popup",function(){register.focus()})}}),function(r){var errors={UNKNOWN_ERROR:r._("unknown error %(message)s"),NO_TEXT:r._("we need something here"),TOO_LONG:r._("this is too long (max: %(max_length)s)"),TOO_SHORT:r._("this is too short (min: %(min_length)s)"),SR_RULE_EXISTS:r._("A subreddit rule by that name already exists."),SR_RULE_TOO_MANY:r._("This subreddit already has the maximum number of rules.")};function CustomErrorPrototype(){}function _getStack(err){var stack=err.stack;return stack&&stack.split("\n").slice(1).join("\n")}function ApiError(displayName,displayMessage,field,source){if(!(this instanceof ApiError))return new ApiError(displayName,displayMessage,field,source);var err=Error.call(this);if("stack"in err)if("captureStackTrace"in Error)Error.captureStackTrace(this,ApiError);else try{Object.defineProperty(this,"stack",{configurable:!0,get:function(){var stack=_getStack(err);return this.stack=stack}})}catch(e){this.stack=_getStack(err)}var errorMessage=displayName+" | "+displayMessage;this.name="ApiError",this.message=errorMessage,this.displayName=displayName,this.displayMessage=displayMessage,this.field=field||"",this.source=source||"api"}CustomErrorPrototype.prototype=Error.prototype,ApiError.prototype=new CustomErrorPrototype,r.errors={create:function(name,message,field,source){return new ApiError(name,message,field,source)},formatAPIError:function(apiErrorArray){return new ApiError(apiErrorArray[0],apiErrorArray[1],apiErrorArray[2])},getAPIErrorsFromResponse:function(res){if(res&&res.json&&res.json.errors&&res.json.errors.length)return res.json.errors.map(r.errors.formatAPIError);if(!res||res.error&&"string"==typeof res.error){var message=res?res.error:"unknown";return[r.errors.createAPIError("","UNKNOWN_ERROR",{message:message})]}},createAPIError:function(field,key,messageParams){var message=errors[key]||"unknown";return messageParams&&(message=message.format(messageParams)),new ApiError(key,message,field,"client")},_getErrorFieldSelector:function(apiError){var selector=".error."+apiError.displayName;return apiError.field&&(selector+=".field-"+apiError.field),selector},showAPIError:function(form,apiError){var selector=this._getErrorFieldSelector(apiError);$(form).find(selector).text(apiError.displayMessage).css("display","inline")},showAPIErrors:function(form,apiErrors){apiErrors.forEach(function(apiError){r.errors.showAPIError(form,apiError)})},clearAPIErrors:function(form,apiErrors){var selector;selector=apiErrors?apiErrors.map(this._getErrorFieldSelector).join(", "):".error",$(form).find(selector).text("").css("display","none")}}}(r),function(r){r.ui=r.ui||{};var activePopup=null;function GatePopup(options){var realPopup,fakePopup={show:function(){realPopup||function(){var content=options.content||$("#"+options.templateId).html();(realPopup=new r.ui.Popup({size:"large",content:content,className:options.className})).$.on("click",".interstitial .c-btn",function(e){return realPopup.hide(),!1}),realPopup.on("closed.r.popup",function(){activePopup===fakePopup&&(activePopup=null)})}(),activePopup!==this&&(activePopup&&activePopup.hide(),activePopup=this,realPopup.show())},hide:function(){this===activePopup&&(activePopup=null),realPopup.hide()}};return fakePopup}r.ui.createGatePopup=function(options){if(!options)throw r.errors.createError("GATE_POPUP_JS_ERROR","no options given");if(!options.templateId&&!options.content)throw r.errors.createError("GATE_POPUP_JS_ERROR","missing templateId or content option");return new GatePopup(options)}}(r),function(r){r.locked={},_.extend(r.locked,{init:function(){$("body").on("click",".locked-error",this._handleClick),this._popup=r.ui.createGatePopup({templateId:"locked-popup",className:"locked-error-modal"})},_handleClick:function(e){if(!r.access.isLinkRestricted(e.target))return this._popup.show(),!1}.bind(r.locked)})}(r),function(r){r.timeouts={},_.extend(r.timeouts,{init:function(){$("body").on("click",".access-required",this._handleClick),$(".access-required").removeAttr("onclick"),$("body.comments-page").on("focus",".usertext.cloneable textarea",function(e){$(this).blur(),r.timeouts._handleClick(e)}),$("body.comments-page").on("submit","form.usertext.cloneable",this._handleClick),$("body.comments-page form.usertext.cloneable").removeAttr("onsubmit");var isLinkRestricted=r.access.isLinkRestricted;r.access.isLinkRestricted=function(el){return r.timeouts.isLinkRestricted(el)||isLinkRestricted(el)},this._popup=r.ui.createGatePopup({templateId:"access-popup",className:"access-denied-modal"})},_logEvent:function(e){var target=$(e.target),thing=target.thing(),targetType=target.data("type")||thing.data("type"),targetFullname=target.data("fullname")||thing.data("fullname"),actionName=target.data("event-action"),actionDetail=target.data("event-detail");actionName||(actionName="modal",actionDetail=null),targetFullname||"subreddit"!=targetType?targetFullname||"link"!=targetType||(targetFullname=r.config.cur_link):targetFullname=r.config.cur_site,r.analytics.timeoutForbiddenEvent(actionName,actionDetail,targetType,targetFullname)},_handleClick:function(e){return this._popup.show(),this._logEvent(e),!1}.bind(r.timeouts),isLinkRestricted:function(el){return $(el).hasClass("access-required")&&r.config.user_in_timeout}}),r.access.initHook(function(){r.config.user_in_timeout&&r.timeouts.init()})}(r),function(r){r.archived={init:function(){this._popup=r.ui.createGatePopup({templateId:"archived-popup",className:"archived-error-modal"}),$("body").on("click",".archived",this._handleClick.bind(this))},_handleClick:function(e){return this._popup.show(),!1}},r.hooks.get("reddit").register(function(){r.archived.init()})}(r),r.newsletter={post:function(form){$('input[name="email"]',form.$el).val();var apiTarget=form.$el.attr("action"),params=form.serialize();return params.push({name:"api_type",value:"json"}),r.ajax({url:apiTarget,type:"POST",dataType:"json",data:params,xhrFields:{withCredentials:!0}})}},r.newsletter.ui={_setupNewsletterBar:function(){!!store.safeGet("newsletterbar.seen")||r.ui.isSmallScreen()||($(".newsletterbar").show(),$(".newsletter-close").on("click",function(){$(".newsletterbar").hide()}),store.safeSet("newsletterbar.seen",!0))},_setupNewsletter:function(){$("body").hasClass("newsletter")&&$(".faq-toggle").click(function(e){e.preventDefault(),$(this).toggleClass("active"),$(".faq").slideToggle(),r.analytics.fireGAEvent("newsletter-form","faq-toggle")})},init:function(){$(".newsletter-signup").each(function(i,el){new r.newsletter.ui.NewsletterForm(el)}),this._setupNewsletterBar(),this._setupNewsletter()}},r.newsletter.ui.NewsletterForm=function(){r.ui.Form.apply(this,arguments)},r.newsletter.ui.NewsletterForm.prototype=$.extend(new r.ui.Form,{showStatus:function(){this.$el.find(".error").css("opacity",1),r.ui.Form.prototype.showStatus.apply(this,arguments)},_submit:function(){return r.analytics.fireGAEvent("newsletter-form","submit"),r.newsletter.post(this)},_showSuccess:function(){var parentEl=this.$el.parents(".newsletter-container");parentEl.find(".result-message").text(r._("check your inbox to confirm your subscription")),parentEl.addClass("success"),parentEl.find("header").fadeTo(250,1)},_handleResult:function(result){if(result.json.errors.length)return r.ui.Form.prototype._handleResult.call(this,result);this.$el.parents(".newsletter-container").find("header, form").fadeTo(250,0,function(){this._showSuccess()}.bind(this))}}),$(function(){function showSaveButton(field){$(field).parent().parent().addClass("edited"),$(field).parent().parent().find(".status").empty()}function onEdit(){$(this).data("saved")!=$(this).val()&&showSaveButton(this)}function onDelete(e){return e.preventDefault(),post_form(this.parentNode,e.data.action)}function onSubmit(e){return e.preventDefault(),$(this).removeClass("edited"),post_form(this,e.data.action)}function getFlairAttrs($el){return $el.data("name")?{name:$el.data("name")}:{link:$el.thing_id()}}function selectFlairInSelector(e){$(".flairselector li").removeClass("selected"),$(this).addClass("selected");var form=$(this).parent().parent().siblings("form")[0];$(form).children('input[name="flair_template_id"]').val(this.id);var customizer=$(form).children(".customizer"),input=customizer.children("input");$(this).hasClass("texteditable")?(customizer.addClass("texteditable"),input.removeAttr("disabled"),input.css("display","block"),input.val($.trim($(this).find(".flair, .linkflairlabel").text())).select(),input.keyup(function(){$(".flairselection .flair, .flairselection .linkflairlabel").text($(input).val()).attr("title",$(input).val())})):(customizer.removeClass("texteditable"),input.attr("disabled","disabled").hide());var remover=$(".flairselector .flairremove").detach();return $(".flairselection").html($(this).first().children().clone()).append(remover),$(".flairselector .flairremove").css("display","inline-block"),!1}function removeFlairInSelector(e){var form=$(this).parent().parent();$(form).children('input[name="flair_template_id"]').val(""),$(form).children(".customizer").hide();var remover=$(".flairselector .flairremove").detach();$(remover).hide(),$(".flairselector li").removeClass("selected"),$(".flairselection").empty().append(remover)}function postFlairSelection(e){$(this).find(".status").html(r.config.status_msg.submitting).show();var $btn=$(this.parentNode.parentNode).find(".flairselectbtn");return simple_post_form(this,"selectflair",getFlairAttrs($btn)),!1}$("#tabbedpane-grant").on("submit",".flair-entry",{action:"flair"},onSubmit),$("#tabbedpane-grant").on("click",".flairdeletebtn",{action:"deleteflair"},onDelete),$("#tabbedpane-templates, #tabbedpane-link_templates").on("submit",".flair-entry",{action:"flairtemplate"},onSubmit),$("form.clearflairtemplates").on("submit",{action:"clearflairtemplates"},onSubmit),$(".flairlist").on("focus",".flaircell input",function(){showSaveButton(this)}).on("keyup",".flaircell input",onEdit).on("change",".flaircell input",onEdit).on("click",".flairtemplate .flairdeletebtn",{action:"deleteflairtemplate"},onDelete),$(".flairtoggle").submit(function(){return post_form(this,"setflairenabled")}),$(".flairtoggle input").change(function(){$(this).parent().submit()}),$(document).on("click",".tagline .flairselectbtn, .thing .flairselectbtn",function(e){if(r.access.isLinkRestricted(e.target))return!1;close_menus(e);var button=this,selector=$(button).siblings(".flairselector")[0];$(selector).html('<img class="flairthrobber" src="'+r.utils.staticURL("throbber.gif")+'" />').addClass("active").height(18).width(18).css("padding-left",4).css("padding-top",4).css("padding-bottom",4).css("padding-right",4).css("left",$(button).position().left+$(button).width()-18+"px").css("top",$(button).position().top+"px");var attrs=getFlairAttrs($(this));return $.request("flairselector",attrs,function(r){$(selector).html(r);var ul=$(".flairselector ul"),width=Math.max(200,ul.length?function(col){var length=$(col).children().length,num_cols=Math.max(1,Math.min(3,Math.ceil(length/10))),height=Math.ceil(length/num_cols),col_width=Math.max(150,$(col).width());if($(col).width(col_width),1<num_cols){$(col).css("float","left");for(var num_short_cols=num_cols*height-length,i=1;i<num_cols;i++){var h=height;i<=num_short_cols&&h--;var start=length-h;length-=h;var tail=$(col).children().slice(start).remove();$(tail).width(col_width),$(col).after($("<ul>").css("float","left").append(tail))}}return num_cols*(col_width+5)+50}(ul):$(".error").width()+20),left=Math.max(100,$(button).position().left+$(button).width()-width);$(selector).height("auto").width(width).css("left",left+"px").click(!1).find(".flairselection").click(!1).end().find("form").click(function(e){e.stopPropagation()}).submit(postFlairSelection).end().find(".customizer input").attr("disabled","disabled").end().find("li.selected").each(selectFlairInSelector).end().find("li:not(.error)").click(selectFlairInSelector).end().find(".flairremove").click(removeFlairInSelector).end()},!0,"html"),!1}),$(".flairselector .dropdown").click(function(){return open_menu(this),$(this).addClass("active"),!1})}),$(function(){var templates,cachedRules;function _getTemplate(id){var elem=document.getElementById(id);return _.template(elem.innerHTML)}function renderFromTemplate(data,thingType){var template,templateData,hasSubreddit=!!data.sr_name,hasRules=data.rules&&0<data.rules.length;return template=hasSubreddit?hasRules?templates.subredditRules:templates.subredditDefault:templates.reddit,hasRules?(templateData=_.clone(data)).rules=data.rules.filter(function(rule){return!rule.kind||rule.kind===thingType}):templateData=data,template(templateData)}function showForm($reportForm,form){$reportForm.empty(),$reportForm.append(form),$(form).css("display","block")}function toggleReportForm(){return $(this).closest(".reportform").toggleClass("active"),!1}function toggleOther(){var $reportForm=$(this).closest(".reportform"),$submit=$reportForm.find('[type="submit"]'),$reason=$reportForm.find("[name=reason]:checked"),$other=$reportForm.find('[name="other_reason"]'),isOther="other"===$reason.val();return $submit.removeAttr("disabled"),isOther?$other.removeAttr("disabled").focus():$other.attr("disabled","disabled"),!1}function openReportForm(e){if(!r.access.isLinkRestricted(e.target)){var $thing=$(this).closest(".thing"),srFullname=$thing.data("subreddit-fullname"),thingType=$thing.data("type"),$reportForm=$(this).closest(".flat-list").siblings(".reportform").eq(0);if($reportForm.toggleClass("active"),$reportForm.hasClass("active")){$reportForm.on("change","select[name=site_reason]",function(){$reportForm.find(".site-reason-radio").focus().prop("checked",!0)}),$reportForm.on("click","select[name=site_reason]",function(){$reportForm.find(".site-reason-radio").prop("checked",!0),toggleOther.call(this)}),$reportForm.html('<img class="flairthrobber" />'),$reportForm.children("img").attr("src",r.utils.staticURL("throbber.gif"));var attrs=function($el){return{thing:$el.thing_id()}}($(this));if(!(templates&&r.config.feature_new_report_dialog))$.request("report_form",attrs,function(res){var form=$.parseHTML(res);showForm($reportForm,form)},!0,"html",!0);else if(srFullname)if(srFullname in cachedRules){(formData=cachedRules[srFullname]).fullname=attrs.thing;form=renderFromTemplate(formData,thingType);showForm($reportForm,form)}else attrs.api_type="json",$.request("report_form",attrs,function(res){var data=res.json.data;(cachedRules[srFullname]=data).fullname=attrs.thing;try{var rulesJSON=JSON.stringify(cachedRules);window.sessionStorage.setItem("subreddit-rules",rulesJSON)}finally{var form=renderFromTemplate(data,thingType);showForm($reportForm,form)}},!0,"json",!0);else{var formData,form=renderFromTemplate(formData={fullname:attrs.thing},thingType);showForm($reportForm,form)}return!1}}}r.hooks.get("setup").register(function(){if(r.config.feature_new_report_dialog)try{!function(){var subredditRulesTemplate=_getTemplate("subreddit-rules-report-template"),subredditDefaultTemplate=_getTemplate("subreddit-default-report-template"),redditTemplate=_getTemplate("reddit-report-template"),reasonTemplate=_getTemplate("report-reason-template");templates={subredditRules:function(data){var rulesStr=data.rules.map(reasonTemplate).join("\n"),formStr=subredditRulesTemplate(data),formEl=$.parseHTML(formStr),rulesEls=$.parseHTML(rulesStr);return $(formEl).find(".report-reason-list").prepend(rulesEls),formEl},subredditDefault:function(data){var formStr=subredditDefaultTemplate(data);return $.parseHTML(formStr)},reddit:function(data){var formStr=redditTemplate(data);return $.parseHTML(formStr)}};try{cachedRules=window.sessionStorage.getItem("subreddit-rules"),cachedRules=JSON.parse(cachedRules)}finally{cachedRules=cachedRules||{}}r.rulesSessionStorageKey="subreddit-rules",r.hooks.get("new-report-form").call()}()}catch(err){}$("div.content").on("submit",".subreddit-report-form",function(e){var $actionForm=$(e.target);return post_pseudo_form($actionForm,"report")}),$("div.content").on("click",".tagline .reportbtn, .thing .reportbtn",openReportForm),$("div.content").on("click",".btn.report-cancel",toggleReportForm),$("div.content").on("change","input[name='reason']",toggleOther)})}),r.interestbar={init:function(){new r.ui.InterestBar($(".sr-interest-bar"))}},r.ui.InterestBar=function(){r.ui.Base.apply(this,arguments),this.$query=this.$el.find(".query"),this.queryChangedDebounced=_.debounce($.proxy(this,"queryChanged"),500),this.$query.on("keyup",$.proxy(this,"keyPressed")),this.$query.on("focus",$.proxy(function(){this.$el.addClass("focus")},this)).on("blur",$.proxy(function(){this.$el.removeClass("focus")},this))},r.ui.InterestBar.prototype={keyPressed:function(){var query=this.$query.val();(query=$.trim(query))!=this._lastQuery&&(this._lastQuery=query,this.queryChangedDebounced(query),query&&1<query.length?this.$el.addClass("working"):(this.hideResults(),this.$el.removeClass("working error")))},queryChanged:function(query){query&&1<query.length&&$.ajax({url:"/api/subreddits_by_topic.json",data:{query:query},success:$.proxy(this,"displayResults"),error:$.proxy(this,"displayError")})},displayResults:function(results){this.$el.removeClass("working error");var first=this.$el.find(".results li:first"),last=this.$el.find(".results li:last"),item=_.template('<li><a href="/'+r.config.brander_community_abbr+'/<%= name %>" target="_blank">/'+r.config.brander_community_abbr+"/<%= name %></a></li>");this.$el.find(".results").empty().append(first).append(_.map(results,item).join("")).append(last).slideDown(150)},hideResults:function(){this.$el.find(".results").slideUp(150)},displayError:function(xhr){this.$el.removeClass("working").addClass("error").find(".error-caption").text(r._("an error occurred. please try again later! (status: %(status)s)").format({status:xhr.status})),this.hideResults()}},r.visited={key:"visited",init:function(){this.sendVisits=_.throttle(this._sendVisits,100),r.config.logged&&r.config.store_visits&&($(".content").on("click mousedown keydown",".link:not(.visited) a.title, .link:not(.visited) a.thumbnail",_.bind(this.onVisit,this)),$(".content").on("visit",".link:not(.visited)",_.bind(this.onVisit,this)),this.sendVisits())},onVisit:function(ev){"keydown"===ev.type&&13!==ev.which||("mousedown"!==ev.type||1!==ev.which&&3!==ev.which)&&("click"===ev.type&&1!==ev.which||(this.storeVisit($(ev.target).closest(".thing").data("fullname")),this.sendVisits()))},storeVisit:function(fullname){var fullnames=store.safeGet(this.key)||[];fullnames.push(fullname),store.safeSet(this.key,fullnames)},_sendVisits:function(){var fullnames=store.safeGet(this.key)||[];fullnames.length&&(fullnames=_.last(_.uniq(fullnames),100),r.ajax({type:"POST",url:"/api/store_visits",data:{links:fullnames.join(",")}}),store.safeSet(this.key,[]),$.things.apply($,fullnames).addClass("visited"))}},r.wiki={request:function(req){r.config.logged&&(req.data.uh=r.config.modhash),req.data.page=r.config.wiki_page,$.ajax(req)},baseApiUrl:function(){return r.wiki.baseUrl(!0)},baseUrl:function(api){var base_url="";return api&&(base_url+="/api"),base_url+="/wiki",r.config.is_fake||(base_url="/"+r.config.brander_community_abbr+"/"+r.config.post_site+base_url),base_url},init:function(){$("body.wiki-page").on("click",".revision_hide",this.toggleHide),$("body.wiki-page").on("click",".revision_delete",this.toggleDelete),$("body.wiki-page").on("click",".toggle-source",this.toggleSource)},toggleSource:function(event){event.preventDefault(),$(".wiki-page .source").toggle("slow")},toggleDelete:function(event){event.preventDefault();var $this=$(this),url=r.wiki.baseApiUrl()+"/delete",$this_parent=$this.parents(".revision"),deleted=$this_parent.hasClass("deleted");$this_parent.toggleClass("deleted"),r.wiki.request({url:url,type:"POST",dataType:"json",data:{revision:$this.data("revision"),deleted:!deleted},error:function(){$this_parent.toggleClass("deleted")},success:function(data){data.status?$this_parent.addClass("deleted"):$this_parent.removeClass("deleted")}})},toggleHide:function(event){if(event.preventDefault(),!r.access.isLinkRestricted(this)){var $this=$(this),url=r.wiki.baseApiUrl()+"/hide",$this_parent=$this.parents(".revision");$this_parent.toggleClass("hidden"),r.wiki.request({url:url,type:"POST",dataType:"json",data:{revision:$this.data("revision")},error:function(){$this_parent.toggleClass("hidden")},success:function(data){data.status?$this_parent.addClass("hidden"):$this_parent.removeClass("hidden")}})}},addUser:function(event){event.preventDefault(),$("#usereditallowerror").hide();var $this=$(event.target),url=r.wiki.baseApiUrl()+"/alloweditor/add";r.wiki.request({url:url,type:"POST",data:{username:$this.find('[name="username"]').val()},dataType:"json",error:function(){$("#usereditallowerror").show()},success:function(data){location.reload()}})},submitEdit:function(event){event.preventDefault();var $this=$(event.target),url=r.wiki.baseApiUrl()+"/edit",conflict=$("#wiki_edit_conflict"),special=$("#wiki_special_error");conflict.hide(),special.hide(),params=r.utils.serializeForm($this),$("#wiki_save_button").attr("disabled",!0),$this.addClass("working"),r.wiki.request({url:url,type:"POST",dataType:"json",data:params,error:function(){$this.removeClass("working"),$("#wiki_save_button").removeAttr("disabled")},success:function(){window.location=r.wiki.baseUrl()+"/"+r.config.wiki_page},statusCode:{409:function(xhr){var info=JSON.parse(xhr.responseText),content=$this.children("#wiki_page_content"),diff=conflict.children("#yourdiff");conflict.children("#youredit").val(content.val()),diff.html($.unsafe(info.diffcontent)),$this.children("#previous").val(info.newrevision),content.val(info.newcontent),conflict.fadeIn("slow")},415:function(xhr){var errors=JSON.parse(xhr.responseText).special_errors,specials=special.children("#specials");for(i in specials.empty(),errors)specials.append($("<pre>").text($.unsafe(errors[i])));special.fadeIn("slow")},429:function(xhr){var message=JSON.parse(xhr.responseText).message,specials=special.children("#specials");specials.empty(),specials.text(message),special.fadeIn("slow")}}})},goCompare:function(){v1=$("input:radio[name=v1]:checked").val(),v2=$("input:radio[name=v2]:checked").val(),url=r.wiki.baseUrl()+"/"+r.config.wiki_page+"?v="+v1,v2!=v1&&(url+="&v2="+v2),window.location=url},helpon:function(elem){$(elem).parents("form").children(".markhelp:first").show()},helpoff:function(elem){$(elem).parents("form").children(".markhelp:first").hide()}},r.apps={init:function(){$(".authorized-app").delegate(".app-permissions li","mouseover mouseout",function(e){"mouseover"==e.type?$(this).find(".app-scope").show():$(this).find(".app-scope").hide()}),$("#developed-apps").delegate(".edit-app-button","click",function(){$(this).toggleClass("collapsed").closest(".developed-app").removeClass("collapsed").find(".app-developers").remove().end().find(".edit-app").slideToggle().removeClass("collapsed").end()}).delegate(".edit-app-icon-button","click",function(){$(this).toggleClass("collapsed").closest(".developed-app").find(".ajax-upload-form").show()}),$("#create-app-button").click(function(){$(this).hide(),$("#create-app").fadeIn()})},revoked:function(elem,op){$(elem).closest(".authorized-app").fadeOut()},deleted:function(elem,op){$(elem).closest(".developed-app").fadeOut()}},r.gold={_inlineGilding:!1,_googleCheckoutAnalyticsLoaded:!1,init:function(){$("div.content").on("click",'[name="message"]',this._toggleGiftMessage.bind(this)),$("div.content").on("click","a.give-gold, .gold-payment .close-button",this._toggleThingGoldForm.bind(this)),$("div.content").on("click",".gold-button",this._setGildingProperties.bind(this)),$(".stripe-gold").click(function(){$("#stripe-payment").slideToggle()}),$("#stripe-payment.charge .stripe-submit").on("click",function(){r.gold.tokenThenPost("stripecharge/gold")}),$("#stripe-payment.modify .stripe-submit").on("click",function(){r.gold.tokenThenPost("modify_subscription")}),$("h3.toggle").on("click",function(){$(this).toggleClass("toggled"),$(this).siblings(".details").slideToggle()}),$("dt.toggle").on("click",function(){$(this).toggleClass("toggled"),$(this).next("dd").slideToggle()}),$("body").hasClass("gold-signup")&&r.gold.signupForm.init(),$("form.creddits-gold .remaining").each(r.gold._renderCredditsAmount),$(document.body).on("submit","form.creddits-gold",function(e){return e.preventDefault(),e.stopPropagation(),r.gold._expendCreddits(),$(this).find(".gold-checkout:not(.creddits-gold)").hide(),post_form(this,"spendcreddits")})},_toggleGiftMessage:function(e){var includeMsg=e.target.checked,giftmessage_id=$(e.target).parents(".gold-form").find('[name="giftmessage"]').attr("id");$("#"+giftmessage_id).toggleClass("hidden",!includeMsg)},_toggleThingGoldForm:function(e){if(!r.access.isLinkRestricted(e.target)){var cloneClass,$link=$(e.target),$thing=$link.thing(),thingFullname=$link.thing_id(),wrapId="gold_wrap_"+thingFullname,oldWrap=$("#"+wrapId);if(oldWrap.length)return oldWrap.toggle(),!1;this._inlineGilding=!0,r.analytics.fireFunnelEvent("gold","open-inline-form",{tracker:"goldTracker"}),this._googleCheckoutAnalyticsLoaded||($.getScript("//checkout.google.com/files/digital/ga_post.js"),this._googleCheckoutAnalyticsLoaded=!0),cloneClass=$thing.hasClass("link")?"cloneable-link":"cloneable-comment";var goldwrap=$(".gold-wrap."+cloneClass+":first").clone(),form=goldwrap.find(".gold-form"),authorName=$link.thing().find(".entry .author:first").text(),passthroughs=form.find(".passthrough"),cbBaseUrl=form.find('[name="cbbaseurl"]').val(),signed=!form.find('[name="signed"]').is(":checked");goldwrap.removeClass(cloneClass).addClass("inline-gold").prop("id",wrapId),form.find("p:first-child em").text(authorName),form.find("button").attr("disabled",""),passthroughs.val(""),$link.new_thing_child(goldwrap);var workingTimer=setTimeout(function(){form.addClass("working"),form.find("button").addClass("disabled")},200);return $.request("generate_payment_blob.json",{thing:thingFullname,signed:signed},function(token){clearTimeout(workingTimer),form.removeClass("working"),passthroughs.val(token),form.find(".stripe-gold").on("click",function(){window.open("/gold/creditgild/"+token)}),form.find(".coinbase-gold").on("click",function(){window.open(cbBaseUrl+"?c="+token)}),form.find("button").removeAttr("disabled").removeClass("disabled")}),!1}},_setGildingProperties:function(e){var $button=$(e.target),thingFullname=$button.thing_id();if(thingFullname){var $goldwrap=$("#"+("gold_wrap_"+thingFullname)),code=$goldwrap.find(".passthrough").val(),signed=!$goldwrap.find('[name="signed"]').is(":checked"),giftmessage="";if($goldwrap.find('[name="message"]').is(":checked")&&(giftmessage=$goldwrap.find('[name="giftmessage"]').val()),this._inlineGilding){var options={label:$button.closest("[data-vendor]").data("vendor"),tracker:"goldTracker"};r.analytics.fireFunnelEvent("gold","checkout",options)}$.request("modify_payment_blob.json",{code:code,signed:signed,message:giftmessage},function(){$button.parents("form").submit()})}else $button.parents("form").submit()},_expendCreddits:function(){$(".cloneable-comment, .cloneable-link").find("form.creddits-gold .remaining").each(function(){var $this=$(this),currentCreddits=parseInt($this.data("current"),10),newTotal=parseInt($this.data("total"),10)-currentCreddits;newTotal<currentCreddits?$this.parents("form.creddits-gold").remove():($(this).data("total",newTotal),r.gold._renderCredditsAmount.apply(this))})},_renderCredditsAmount:function(){var $this=$(this),tpl=$this.data("template");$this.html(_.template(tpl,_.omit($this.data(),"template")))},gildThing:function(thing_fullname,new_title,specified_gilding_count){var thing=$(".id-"+thing_fullname);if(thing.length){var gilding_count,tagline=thing.children(".entry").find("p.tagline"),icon=tagline.find(".gilded-icon");null!=specified_gilding_count?gilding_count=specified_gilding_count:(gilding_count=icon.data("count")||0,gilding_count++),thing.addClass("gilded user-gilded"),icon.length||(icon=$("<span>").addClass("gilded-icon"),tagline.append(icon)),icon.attr("title",new_title).data("count",gilding_count),1<gilding_count&&icon.text("x"+gilding_count),thing.children(".entry").find(".give-gold").parent().remove()}else console.log("couldn't gild thing "+thing_fullname)},tokenThenPost:function(dest){r.gold.makeStripeToken(function(status_code,response){var form=$("#stripe-payment"),submit=form.find(".stripe-submit"),status=form.find(".status"),token=form.find('[name="stripeToken"]');response.error?(submit.removeAttr("disabled"),status.html(response.error.message)):(token.val(response.id),post_form(form,dest))})},makeStripeToken:function(responseHandler){var form=$("#stripe-payment"),publicKey=form.find('[name="stripePublicKey"]').val(),submit=form.find(".stripe-submit"),status=form.find(".status"),cardName=(form.find('[name="stripeToken"]'),form.find(".card-name").val()),cardNumber=form.find(".card-number").val(),cardCvc=form.find(".card-cvc").val(),expiryMonth=form.find(".card-expiry-month").val(),expiryYear=form.find(".card-expiry-year").val(),cardAddress1=form.find(".card-address_line1").val(),cardAddress2=form.find(".card-address_line2").val(),cardCity=form.find(".card-address_city").val(),cardState=form.find(".card-address_state").val(),cardCountry=form.find(".card-address_country").val(),cardZip=form.find(".card-address_zip").val();Stripe.setPublishableKey(publicKey);function showError(inputSelector,str){form.find(".status").addClass("error").text(str),$(inputSelector).focus()}return cardName?Stripe.validateCardNumber(cardNumber)?Stripe.validateExpiry(expiryMonth,expiryYear)?Stripe.validateCVC(cardCvc)?cardAddress1?cardCity?cardCountry?(status.removeClass("error").text(r.config.status_msg.submitting),submit.attr("disabled","disabled"),Stripe.createToken({name:cardName,number:cardNumber,cvc:cardCvc,exp_month:expiryMonth,exp_year:expiryYear,address_line1:cardAddress1,address_line2:cardAddress2,address_city:cardCity,address_state:cardState,address_country:cardCountry,address_zip:cardZip},responseHandler)):showError(".card-address_country",r._("missing country")):showError(".card-address_city",r._("missing city")):showError(".card-address_line1",r._("missing address")):showError(".card-cvc",r._("invalid cvc")):showError(".card-expiry-month",r._("invalid expiration date")):showError(".card-number",r._("invalid credit card number")):showError(".card-name",r._("missing name")),!1}},r.gold.signupForm=function(){function _getRelevantFields(){var fields=["goldtype"];switch($("#goldtype").val()){case"autorenew":fields.push("period");break;case"onetime":fields.push("months");break;case"code":fields.push("months","email");break;case"gift":fields.push("months","recipient","signed","giftmessage");break;case"creddits":fields.push("num_creddits")}return fields}function _updateUrlState(){var a=$("<a />").get(0),urlFields=_getRelevantFields(),params={};"replaceState"in window.history&&($("form.gold-form").find(":input").each(function(){$(this);if(_.contains(urlFields,this.name))try{params[this.name]=function(field){var $field=$(field);if($field.is(":radio")&&!$field.is(":checked"))throw"Unchecked radio button has no value";return $field.is(":checkbox")?value=$field.is(":checked")?$field.val():null:$field.is("select")?value=$field.find("option:selected").val():value=$field.val(),value}(this)}catch(e){return}}),params.edit=!0,a.href=window.location.href,a.search=$.param(params),window.history.replaceState({},"",a.href))}function _updateGoldType(){var goldtype,$gifttype=$('input[name="gifttype"]:checked'),$tab=$(".tab.active"),isGift=$("#gift").is(":checked");goldtype="autorenew"==$tab.prop("id")?"autorenew":"creddits"==$tab.prop("id")?"creddits":isGift&&0<$gifttype.length?$gifttype.val():"onetime",$("#goldtype").val(goldtype),_updateUrlState()}function _handleSubmit(e){e.stopPropagation(),e.preventDefault(),$("#giftmessage, #recipient").each(function(){var $this=$(this);$this.val()===$this.attr("placeholder")&&$this.val("")});var fields=$("form.gold-form").serializeArray(),fieldsAsDict=_.object(_.pluck(fields,"name"),_.pluck(fields,"value")),submission=_.pick(fieldsAsDict,_getRelevantFields());window.location="/gold/payment?"+$.param(submission)}return{init:function(){var $form=$("form.gold-form");$("a.tab-toggle").on("click",function(e){e.stopPropagation(),e.preventDefault(),function(tab){$("#form-options, #payment-options").show(),$(".active").removeClass("active"),$("#redeem-a-code, .question").hide(),$(tab).addClass("active"),$(tab.hash).addClass("active"),_updateGoldType()}(this)}),$('input[name="gift"]').change(function(){$("#gifting-details").slideToggle($(this).val()),_updateGoldType()}),$(".gold-dropdown").on("change",function(){$(this).find("[selected]").removeAttr("selected"),$(this).find(":selected").get(0).setAttribute("selected","selected")});var hasPlaceholder="placeholder"in document.createElement("input");$('input[name="gifttype"]').change(function(){$("#gifttype-details-gift").toggleClass("hidden","gift"!==this.value),hasPlaceholder&&$("#gifttype-details-gift :input:eq(0)").focus(),_updateGoldType()}),$("#giftmessage").on("keyup",function(){$("#message").prop("checked",""!==$(this).val())}),$form.on("submit",_handleSubmit),$form.find(":input").on("change",_updateUrlState),$('input[name="code"]').on("focus",function(){$(".redeem-submit").slideDown()})}}}(),function($){$.gild_thing=function(thing_fullname,new_title){r.gold.gildThing(thing_fullname,new_title),$("#gold_wrap_"+thing_fullname).fadeOut(400)}}(jQuery),r.multi={init:function(){this.multis=new r.multi.GlobalMultiCache,this.mine=new r.multi.MyMultiCollection,this.mine.fetch=_.throttle(this.mine.fetch,6e4);var detailsEl=$(".multi-details");if(detailsEl.length){var multi=this.multis.touch(detailsEl.data("path"));multi.fetch();var detailsView=new r.multi.MultiDetails({model:multi,el:detailsEl}).render();new r.multi.SubredditList({model:multi,el:detailsEl});"#created"==location.hash&&detailsView.focusAdd();var recsEl=$("#multi-recs");recsEl.length&&detailsView.initRecommendations(recsEl)}var subscribeBubbleGroup={};$(".subscribe-button").each(function(idx,el){new r.multi.SubscribeButton({el:el,bubbleGroup:subscribeBubbleGroup})}),$(".listing-chooser").each(function(idx,el){new r.multi.ListingChooser({el:el})})}},r.multi.MultiRedditList=Backbone.Collection.extend({model:Backbone.Model.extend({initialize:function(){this.id=this.get("name").toLowerCase()}}),comparator:function(model){return model.id},getByName:function(name){return this.get(name.toLowerCase())}}),r.multi.MultiReddit=Backbone.Model.extend({idAttribute:"path",url:function(){return r.utils.joinURLs("/api/multi",this.id)},defaults:{visibility:"private"},initialize:function(attributes,options){this.uncreated=options&&!!options.isNew,this.subreddits=new r.multi.MultiRedditList(this.get("subreddits"),{url:this.url()+"/"+r.config.brander_community_abbr+"/",parse:!0}),this.on("change:subreddits",function(model,value){this.subreddits.set(value,{parse:!0})},this),this.subreddits.on("request",function(model,xhr,options){this.trigger("request",model,xhr,options)},this)},parse:function(response){return response.data},toJSON:function(){return data=Backbone.Model.prototype.toJSON.apply(this),data.subreddits=this.subreddits.toJSON(),data},isNew:function(){return this.uncreated},name:function(){return this.get("path").split("/").pop()},sync:function(method,model,options){var res=Backbone.sync.apply(this,arguments);return"create"==method&&res.done(_.bind(function(){this.uncreated=!1},this)),res},addSubreddit:function(names,options){if(1==(names=r.utils.tup(names)).length)this.subreddits.create({name:names[0]},options);else{var subreddits=this.subreddits,tmp=subreddits.clone();tmp.add(_.map(names,function(srName){return{name:srName}})),this.subreddits=tmp,this.save(null,options),this.subreddits=subreddits}},removeSubreddit:function(name,options){this.subreddits.getByName(name).destroy(options)},_copyOp:function(op,newCollection,newName){var deferred=new $.Deferred;return Backbone.ajax({type:"POST",url:"/api/multi/"+op,data:{from:this.get("path"),to:newCollection.pathByName(newName)},success:_.bind(function(resp){"rename"==op&&this.trigger("destroy",this,this.collection);var multi=r.multi.multis.reify(resp);newCollection.add(multi),deferred.resolve(multi)},this),error:_.bind(deferred.reject,deferred)}),deferred},copyTo:function(newCollection,name){return this._copyOp("copy",newCollection,name)},renameTo:function(newCollection,name){return this._copyOp("rename",newCollection,name)},getSubredditNames:function(){return this.subreddits.pluck("name")}}),r.multi.MyMultiCollection=Backbone.Collection.extend({url:"/api/multi/mine",model:r.multi.MultiReddit,comparator:function(model){return model.get("path").toLowerCase()},parse:function(data){return _.map(data,function(multiData){return r.multi.multis.reify(multiData)})},pathByName:function(name){return"/user/"+r.config.logged+"/m/"+name}}),r.multi.GlobalMultiCache=Backbone.Collection.extend({model:r.multi.MultiReddit,touch:function(path){var multi=this.get(path);return multi||(multi=new this.model({path:path}),this.add(multi)),multi},reify:function(response){var data=this.model.prototype.parse(response),multi=this.touch(data.path);return multi.set(data),multi}}),r.multi.MultiSubredditItem=Backbone.View.extend({tagName:"li",template:_.template('<a href="/'+r.config.brander_community_abbr+'/<%- sr_name %>">/'+r.config.brander_community_abbr+'/<%- sr_name %></a><button class="remove-sr">x</button>'),events:{"click .remove-sr":"removeSubreddit"},render:function(){return this.$el.append(this.template({sr_name:this.model.get("name")})),r.config.logged&&(this.bubble=new r.multi.MultiSubscribeBubble({parent:this.$el,group:this.options.bubbleGroup,srName:this.model.get("name")})),this},remove:function(){this.bubble&&this.bubble.remove(),Backbone.View.prototype.remove.apply(this)},removeSubreddit:function(ev){this.options.multi.removeSubreddit(this.model.get("name"))}}),r.multi.SubredditList=Backbone.View.extend({events:{"submit .add-sr":"addSubreddit"},initialize:function(){this.listenTo(this.model.subreddits,"add",this.addOne),this.listenTo(this.model.subreddits,"remove",this.removeOne),this.listenTo(this.model.subreddits,"sort",this.resort),new r.ui.ConfirmButton({el:this.$("button.delete")}),this.listenTo(this.model.subreddits,"add remove",function(){r.ui.showWorkingDeferred(this.$el,r.ui.refreshListing())}),this.model.on("request",function(model,xhr){r.ui.showWorkingDeferred(this.$el,xhr)},this),this.itemView=this.options.itemView||r.multi.MultiSubredditItem,this.itemViews={},this.bubbleGroup={},this.$(".subreddits").empty(),this.model.subreddits.each(this.addOne,this)},addOne:function(sr){var view=new this.itemView({model:sr,multi:this.model,bubbleGroup:this.bubbleGroup});this.itemViews[sr.id]=view,this.$(".subreddits").append(view.render().$el)},resort:function(){this.model.subreddits.each(function(sr){this.itemViews[sr.id].$el.appendTo(this.$(".subreddits"))},this)},removeOne:function(sr){this.itemViews[sr.id].remove(),delete this.itemViews[sr.id]},addSubreddit:function(ev){ev.preventDefault();var nameEl=this.$(".add-sr .sr-name"),srNames=nameEl.val();srNames=(srNames=srNames.split(/[+,\-\s]+/)).map(function(sr){return sr.replace("/^/?"+r.config.brander_community_abbr+"//","")}),(srNames=_.compact(srNames)).length&&(nameEl.val(""),this.$(".add-error").css("visibility","hidden"),this.model.addSubreddit(srNames,{wait:!0,success:_.bind(function(){this.$(".add-error").hide()},this),error:_.bind(function(model,xhr){var resp=JSON.parse(xhr.responseText);this.$(".add-error").text(resp.explanation).css("visibility","visible").show()},this)}))}}),r.multi.MultiDetails=Backbone.View.extend({events:{'change [name="visibility"]':"setVisibility",'change [name="key_color"]':"setKeyColor",'change [name="icon_name"]':"setIconName","click .show-copy":"showCopyMulti","click .show-rename":"showRenameMulti","click .edit-description":"editDescription","submit .description":"saveDescription","confirm .delete":"deleteMulti"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model.subreddits,"add remove reset",this.render),this.addBubble=new r.multi.MultiAddNoticeBubble({parent:this.$(".add-sr .sr-name"),trackHover:!1})},initRecommendations:function(recsEl){var recs=new r.recommend.RecommendationList;this.recsView=new r.recommend.RecommendationsView({collection:recs,el:recsEl}),this.model.subreddits.isEmpty()||recs.fetchForSrs(this.model.getSubredditNames()),this.listenTo(this.model.subreddits,"add remove reset",function(){var srNames=this.model.getSubredditNames();recs.fetchForSrs(srNames)}),this.recsView.bind("recs:select",function(data){this.model.addSubreddit(data.srName)},this)},render:function(){var canEdit=this.model.get("can_edit");return canEdit&&(this.model.subreddits.isEmpty()?this.addBubble.show():this.addBubble.hide()),this.$el.toggleClass("readonly",!canEdit),this.$el.toggleClass("public","public"==this.model.get("visibility")),this.model.has("description_html")&&this.$(".description .usertext-body").html(this.model.get("description_html")),this.$(".count").text(this.model.subreddits.length),this},setVisibility:function(){this.model.save({visibility:this.$('[name="visibility"]:checked').val()})},setKeyColor:function(){this.model.save({key_color:this.$('[name="key_color"]').val()})},setIconName:function(){this.model.save({icon_name:this.$('[name="icon_name"]').val()})},showCopyMulti:function(){this.$("form.rename-multi").hide();var $copyForm=this.$("form.copy-multi");$copyForm.show().find(".multi-name").val(this.model.name()).select().focus(),this.copyForm||(this.copyForm=new r.multi.MultiCopyForm({el:$copyForm,navOnCreate:!0,sourceMulti:this.model}))},showRenameMulti:function(){this.$("form.copy-multi").hide();var $renameForm=this.$("form.rename-multi");$renameForm.show().find(".multi-name").val(this.model.name()).select().focus(),this.renameForm||(this.renameForm=new r.multi.MultiRenameForm({el:$renameForm,navOnCreate:!0,sourceMulti:this.model}))},deleteMulti:function(){this.model.destroy({success:function(){window.location="/"}})},editDescription:function(){show_edit_usertext(this.$el)},saveDescription:function(ev){ev.preventDefault(),this.model.save({description_md:this.$(".description textarea").val()},{success:_.bind(function(){hide_edit_usertext(this.$el)},this)})},focusAdd:function(){this.$(".add-sr .sr-name").focus()}}),r.multi.MultiAddNoticeBubble=r.ui.Bubble.extend({className:"multi-add-notice hover-bubble anchor-right",template:_.template("<h3><%- awesomeness_goes_here %></h3><p><%- add_multi_sr %></p>"),render:function(){this.$el.html(this.template({awesomeness_goes_here:r._("awesomeness goes here"),add_multi_sr:r._("add a subreddit to your multi.")}))}}),r.multi.SubscribeButton=Backbone.View.extend({events:{mouseenter:"createBubble"},createBubble:function(){if(!this.bubble){this.bubble=new r.multi.MultiSubscribeBubble({parent:this.$el,group:this.options.bubbleGroup,srName:String(this.$el.data("sr_name"))});var bubbleClass=this.$el.data("bubble_class");bubbleClass&&(this.bubble.$el.removeClass("anchor-right"),this.bubble.$el.addClass(bubbleClass)),this.bubble.queueShow()}}}),r.multi.MultiSubscribeBubble=r.ui.Bubble.extend({className:"multi-selector hover-bubble anchor-right",template:_.template('<div class="title"><strong><%- title %></strong><a class="sr" href="/'+r.config.brander_community_abbr+'/<%- sr_name %>">/'+r.config.brander_community_abbr+'/<%- sr_name %></a></div><div class="throbber"></div>'),itemTemplate:_.template('<label><input class="add-to-multi" type="checkbox" data-path="<%- path %>" <%- checked %>><%- name %><a href="<%- path %>" target="_blank" title="<%- open_multi %>">&rsaquo;</a></label>'),itemCreateTemplate:_.template('<label><form class="create-multi"><input type="text" class="multi-name" placeholder="<%- create_msg %>"><div class="error create-multi-error"></div></form></label>'),events:{"click .add-to-multi":"toggleSubscribed"},initialize:function(){this.listenTo(this,"show",this.load),this.listenTo(r.multi.mine,"reset add",_.debounce(this.render,100)),r.ui.Bubble.prototype.initialize.apply(this)},load:function(){r.ui.showWorkingDeferred(this.$el,r.multi.mine.fetch())},render:function(){this.$el.html(this.template({title:r._("categorize"),sr_name:this.options.srName}));var content=$('<div class="multi-list">');r.multi.mine.chain().sortBy(function(multi){return multi.subreddits.getByName(this.options.srName)},this).each(function(multi){content.append(this.itemTemplate({name:multi.get("name"),path:multi.get("path"),checked:multi.subreddits.getByName(this.options.srName)?"checked":"",open_multi:r._("open this multi")}))},this),content.append(this.itemCreateTemplate({create_msg:r._("create a new multi")})),this.$el.append(content),this.createForm=new r.multi.MultiCreateForm({el:this.$("form.create-multi")})},toggleSubscribed:function(ev){var checkbox=$(ev.target),multi=r.multi.mine.get(checkbox.data("path"));checkbox.is(":checked")?multi.addSubreddit(this.options.srName):multi.removeSubreddit(this.options.srName)}}),r.multi.MultiCreateForm=Backbone.View.extend({events:{submit:"createMulti"},createMulti:function(ev){ev.preventDefault();var name=this.$("input.multi-name").val();if(name=$.trim(name)){var deferred=this._createMulti(name);deferred.done(_.bind(function(multi){this.trigger("create",multi),this.options.navOnCreate&&(window.location=multi.get("path")+"#created")},this)).fail(_.bind(function(xhr){var resp=JSON.parse(xhr.responseText);this.showError(resp.explanation)},this)),r.ui.showWorkingDeferred(this.$el,deferred)}},_createMulti:function(name){var newMulti=new r.multi.MultiReddit({path:r.multi.mine.pathByName(name)},{isNew:!0}),deferred=new $.Deferred;return r.multi.mine.create(newMulti,{wait:!0,success:_.bind(deferred.resolve,deferred),error:function(multi,xhr){deferred.reject(xhr)}}),deferred},showError:function(error){this.$(".error").text(_.unescape(error)).show()},focus:function(){this.$(".multi-name").focus()}}),r.multi.MultiCopyForm=r.multi.MultiCreateForm.extend({_createMulti:function(name){return this.options.sourceMulti.copyTo(r.multi.mine,name)}}),r.multi.MultiRenameForm=r.multi.MultiCopyForm.extend({_createMulti:function(name){return this.options.sourceMulti.renameTo(r.multi.mine,name)}}),r.multi.ListingChooser=Backbone.View.extend({events:{"click .create button":"createClick","click .grippy":"toggleCollapsed"},initialize:function(){this.$el.addClass("initialized"),1==store.safeGet("ui.collapse.listingchooser")&&this.toggleCollapsed(!0),store.safeSet("ui.collapse.listingchooser");var thisHeight=this.$(".contents").height(),bodyHeight=$("body").height();bodyHeight<thisHeight&&$("body").css("padding-bottom",thisHeight-bodyHeight+100)},createClick:function(ev){this.$(".create").is(".expanded")||(ev.preventDefault(),this.$(".create").addClass("expanded"),this.createForm=new r.multi.MultiCreateForm({el:this.$(".create form"),navOnCreate:!0}),this.createForm.focus())},toggleCollapsed:function(value){$("body").toggleClass("listing-chooser-collapsed",value),Backbone.ajax({type:"POST",url:"/api/set_left_bar_collapsed.json",data:{collapsed:$("body").is(".listing-chooser-collapsed")}})}}),r.filter={},r.filter.init=function(){var detailsEl=$(".filtered-details");if(detailsEl.length){var multi=new r.filter.Filter({path:detailsEl.data("path")});detailsEl.find(".subreddits a").each(function(i,e){multi.subreddits.add({name:$(e).data("name")})}),multi.fetch({error:_.bind(r.multi.mine.create,r.multi.mine,multi,{wait:!0})});new r.multi.SubredditList({model:multi,itemView:r.filter.FilteredSubredditItem,el:detailsEl}).render()}},r.filter.Filter=r.multi.MultiReddit.extend({url:function(){return r.utils.joinURLs("/api/filter",this.id)}}),r.filter.FilteredSubredditItem=r.multi.MultiSubredditItem.extend({render:function(){return this.$el.append(this.template({sr_name:this.model.get("name")})),this}}),r.recommend={init:function(){$(".explore-item").each(function(idx,el){new r.recommend.ExploreItem({el:el})})}},r.recommend.Recommendation=Backbone.Model.extend(),r.recommend.RecommendationList=Backbone.Collection.extend({model:r.recommend.Recommendation,srNames:[],dismissed:[],fetchForSrs:function(srNames){if(!srNames.length)return this.srNames=[],void this.reset([]);this.srNames=srNames,this.fetchRecs()},fetchNewRecs:function(){var currentRecs=this.pluck("sr_name");this.dismissed=_.union(this.dismissed,currentRecs),this.fetchRecs()},fetchRecs:function(){var url="/api/recommend/sr/"+this.srNames.join(",");this.fetch({url:url,data:{omit:this.dismissed.join(",")},reset:!0,error:_.bind(function(){this.reset([])},this)})},clearHistory:function(){this.dismissed=[]}}),r.recommend.RecommendationsView=Backbone.View.extend({collection:r.recommend.RecommendationList,tagName:"div",itemTemplate:_.template('<li class="rec-item"><a href="/'+r.config.brander_community_abbr+'/<%- sr_name %>" title="<%- sr_name %>" target="_blank">/'+r.config.brander_community_abbr+'/<%- sr_name %></a><button class="add add-rec" data-srname="<%- sr_name %>"></button></li>'),initialize:function(){this.listenTo(this.collection,"add remove reset",this.render)},events:{"click .add-rec":"onAddClick","click .more":"showMore","click .reset":"resetRecommendations"},render:function(){if(this.$(".recommendations").empty(),0<this.collection.models.length){this.$(".recs").show(),this.$(".endoflist").hide();this.$el;var view=this;this.collection.each(function(rec){this.$(".recommendations").append(view.itemTemplate({sr_name:rec.get("sr_name")}))},this),this.$el.css({opacity:1})}else 0<this.collection.dismissed.length?(this.$(".recs").hide(),this.$(".endoflist").show()):this.$el.css({opacity:0});return this},resetRecommendations:function(){this.collection.clearHistory(),this.collection.fetchRecs()},onAddClick:function(ev){var srName=$(ev.target).data("srname");this.trigger("recs:select",{srName:srName})},showMore:function(ev){this.collection.fetchNewRecs()}}),r.recommend.ExploreItem=Backbone.View.extend({events:{"click .explore-feedback-dismiss":"dismissSubreddit","click a":"recordClick"},dismissSubreddit:function(ev){var listing=$(ev.target).closest(".explore-item"),sr_name=listing.data("sr_name"),src=listing.data("src");r.ajax({type:"POST",url:"/api/recommend/feedback",data:{type:"dis",srnames:sr_name,src:src,page:"explore"}}),this.$(".explore-feedback-dismiss").css({"font-weight":"bold"}),$(this.el).fadeOut("fast")},recordClick:function(ev){var listing=$(ev.target).closest(".explore-item"),sr_name=listing.data("sr_name"),src=listing.data("src");r.ajax({type:"POST",url:"/api/recommend/feedback",data:{type:"clk",srnames:sr_name,src:src,page:"explore"}})}}),r.actionForm={init:function(){$("div.content").on("click",".action-thing, .cancel-action-thing",this.toggleActionForm.bind(this)),$("div.content").on("submit",".action-form",this.submitAction.bind(this))},toggleActionForm:function(e){var el=e.target,$el=$(el);if(!r.access.isLinkRestricted(el)){var $thing=$el.thing(),$thingForm=$thing.find("> .entry .action-form"),formSelector=$el.data("action-form");if(e.stopPropagation(),e.preventDefault(),0<$thingForm.length)$el.parents(".drop-choices").length?$thingForm.show():$thingForm.toggle();else{var $clonedForm=$(formSelector).clone(),$insertionPoint=$thing.find("> .entry .buttons"),thingFullname=$thing.thing_id();$clonedForm.attr("id","action-thing-"+thingFullname),$clonedForm.find('input[name="thing_id"]').val(thingFullname),$clonedForm.insertAfter($insertionPoint),$clonedForm.show()}}},submitAction:function(e){var $actionForm=$(e.target).thing().find(".action-form"),action=$actionForm.data("form-action");return post_pseudo_form($actionForm,action)}},r.fraud={init:function(){$("div.content").on("click",".action-thing",this.showReason.bind(this)),$("div.content").on("change",".fraud-action-form input",this.validate.bind(this))},validate:function(e){var $form=$(e.target).parents("form"),$submit=$form.find('[type="submit"]'),$refund=$form.find("input[name=refund]"),fraud=$form.find("input[name=fraud]:checked").val();"True"===fraud?$refund.removeAttr("disabled").focus():$refund.prop("checked",!1).attr("disabled","disabled"),fraud?$submit.removeAttr("disabled"):$submit.attr("disabled","disabled")},showReason:function(e){var $el=$(e.target),$reason=$el.thing().find("> .entry .action-form").find(".fraud-reason"),reason=$el.attr("title");$reason.text(reason)}},r.report={init:function(){$("div.content").on("change",".report-action-form input",this.validate.bind(this)),$("div.content").on("click",".reported-stamp.has-reasons",this.toggleReasons.bind(this))},toggleReasons:function(e){r.access.isLinkRestricted(e.target)||$(e.target).parent().find(".report-reasons").toggle()},validate:function(e){var $form=$(e.target).thing().find("> .entry .report-action-form"),$submit=$form.find('[type="submit"]'),$reason=$form.find("[name=reason]:checked"),$other=$form.find('[name="other_reason"]'),isOther="other"===$reason.val();$submit.removeAttr("disabled"),isOther?$other.removeAttr("disabled").focus():$other.attr("disabled","disabled")}},$(function(){r.actionForm.init(),r.fraud.init(),r.report.init()}),function($){var INJECT_TEMPLATE=_.template(_.unescape(r.config.embed_inject_template),!1,{escape:/%\(([^\n\)]+)\)s/g}),embedBodyTemplate=_.template('<h4  class="modal-title">'+_.escape(r._("Embed preview:"))+'</h4><div id="embed-preview"><%= html %></div><% if (!root) { %><div class="c-checkbox"><label class="remember"><input type="checkbox" name="parent" <% if (parent) { %> checked <% } %>>'+_.escape(r._("Include parent comment."))+'</label></div><% } %><div class="c-checkbox"><label><input type="checkbox" name="live" <% if (!live) { %> checked <% } %> data-rerender="false">'+_.escape(r._("Do not show comment if edited."))+'</label>&nbsp;<a href="javascript: void 0;" class="c-toggle" data-toggle="#live-help">'+_.escape(r._("Learn more"))+'</a><div id="live-help" class="c-help-block c-toggle-content"><p>'+_.escape(r._("When checked, if an embedded comment is later edited, the embedded comment text will be replaced by a link back to the current version of the comment on reddit."))+'</p><p><a href="https://www.reddit.com/r/reddit.com/wiki/embeds">'+_.escape(r._("This parameter can be changed after embedding."))+"</a></p></div></div>"),embedFooterTemplate=_.template('<h4 class="modal-title"><label for="embed-code">'+_.escape(r._("Copy this code and paste it into your website:"))+'</label></h4><textarea class="c-form-control" id="embed-code" rows="3" readonly><%- html %></textarea>');_.template('<div class="reddit-embed"  data-embed-media="<%- media %>" <% if (parent) { %> data-embed-parent="true" <% } %><% if (live) { %> data-embed-live="true" <% } %> data-embed-created="<%- new Date().toISOString() %>"><a href="<%- comment %>">Comment</a> from discussion <a href="<%- link %>"><%- title %></a>.</div>');function absolute(url){return/^https?:\/\//.test(url)?url:"https://"+location.host+"/"+url.replace(/^\//,"")}function getEmbedOptions(data){var defaults={live:!0,parent:!1,media:location.host,created:(new Date).toISOString()};return(data=_.defaults({},data,defaults)).comment=absolute(data.comment),data.link=absolute(data.link),_.extend({html:INJECT_TEMPLATE(data)},data)}function serializeOptions(options){return JSON.stringify(_.pick(options,"live","parent"))}function initFrame(popup,options){var $preview=popup.$.find("#embed-preview"),serializedOptions="string"!=typeof options?serializeOptions(options):options;window.rembeddit.preview=!0,window.rembeddit.init({track:!1},function(){var height=0,reflow=setInterval(function(){var newHeight=$preview.find("iframe:last-child").height();height!==newHeight?height=newHeight:(clearInterval(reflow),$preview.find("iframe").hide().last().show().attr("data-options",serializedOptions),$preview.css("height","auto"))},100)})}var tracker=new window.rembeddit.PixelTracker({url:r.config.eventtracker_url});$("body").on("click",".embed-comment",function(e){var $el=$(e.target),embedOptions=getEmbedOptions($el.data()),popup=new r.ui.Popup({className:"embed-modal",content:embedBodyTemplate(embedOptions),footer:embedFooterTemplate(embedOptions)}),$textarea=popup.$.find("textarea"),$preview=popup.$.find("#embed-preview"),created=!1;popup.$.find("[data-toggle]").togglable(),popup.$.on("change",'[type="checkbox"]',function(e){var option=e.target.name,$option=$(e.target),prev=$el.data(option);void 0===prev&&(prev=embedOptions[option]),$el.data(e.target.name,!prev);var options=getEmbedOptions($el.data()),serializedOptions=serializeOptions(options),html=options.html,height=$preview.height();if($textarea.val(html),!1!==$option.data("rerender")){var selector='[data-options="'+r.utils.escapeSelector(serializedOptions)+'"]',$cached=$preview.find(selector);$cached.length?$cached.show().siblings().hide():($preview.height(height).append($(html).hide()),initFrame(popup,serializedOptions))}}),$textarea.on("focus",function(e){if($(this).select().one("mouseup",function(e){e.preventDefault()}),!created){var options=getEmbedOptions($el.data()),now=new Date,ts=now.getTime();tracker.send({event_topic:"embed",event_name:"embed_create",event_ts:ts,event_ts_utc_offset:now.getTimezoneOffset()/-60,embed_type:options.parent?"comment_and_parent":"comment",user_agent:navigator.userAgent,user_id:r.config.user_id,logged_in_status:!!r.config.logged,sr_id:r.utils.fullnameToId(r.config.cur_site),sr_name:r.config.post_site,embed_id:r.utils.fullnameToId($el.thing_id()),embed_created_ts:ts,embed_control:options.live,embed_host_url:location.href,embed_version:window.rembeddit.VERSION}),created=!0}}),popup.on("closed.r.popup",function(){popup.$.remove()}),popup.on("show.r.popup",function(){$preview.find(".reddit-embed").hide()}),popup.on("opened.r.popup",function(){initFrame(popup,embedOptions)}),popup.show()})}(window.jQuery),function(r){"use strict";var shareOptionTemplate=_.template('<div class="post-sharing-option post-sharing-option-<%- name %>" data-post-sharing-option="<%- name %>"><div class="c-tooltip" role="tooltip"><div class="tooltip-arrow bottom"></div><div class="tooltip-inner"><%- tooltip %></div></div></div>'),feedbackTemplate=_.template('<div class="c-form-control-feedback-wrapper" ref="<%- ref %>"><span class="c-form-control-feedback c-form-control-feedback-throbber"></span><span class="c-form-control-feedback c-form-control-feedback-error"></span><span class="c-form-control-feedback c-form-control-feedback-success"></span></div>'),postSharingTemplate=_.template('<a href="javascript: void 0;" class="c-close c-hide-text">'+_.escape(r._("close this window"))+'</a><div class="post-sharing-main post-sharing-form" ref="$mainForm"><% if (options) { %><div class="c-form-group"><div class="post-sharing-label">'+_.escape(r._("Share with:"))+'</div><div class="post-sharing-options"><% options.forEach(function(option) { %><%= option %><% }) %></div></div><% } %><% if (link) { %><div class="c-form-group"><div class="post-sharing-label">'+_.escape(r._("Link:"))+'</div><input class="post-sharing-link-input c-form-control" ref="$postSharingLinkInput" name="link" type="text" readonly value="<%- link %>"></div><% } %> </div><div class="post-sharing-email-form post-sharing-form" ref="$emailForm"><p class="post-sharing-label"><span ref="$emailFormEmailLabel">'+_.escape(r._("Share via email as %(username)s").format({username:r.config.logged}))+'</span><span ref="$emailFormPMLabel">'+_.escape(r._("Share via private message on reddit as %(username)s").format({username:r.config.logged}))+'</span></p><div class="c-form-group"><input class="post-sharing-recipient-input c-form-control" ref="$shareTo" name="recipient" type="text" placeholder="name@example.com, name@example.com" data-placeholder-email="name@example.com, name@example.com" data-placeholder-reddit-pm="username">'+feedbackTemplate({ref:"$shareToFeedback"})+'</div><div class="c-form-group"><textarea class="post-sharing-message-input c-form-control" ref="$shareMessage" name="message" placeholder="'+_.escape(r._("add optional message"))+'"></textarea>'+feedbackTemplate({ref:"$messageFeedback"})+'</div><div class="c-form-group"><div class="post-sharing-buttons"><button class="post-sharing-submit c-btn c-btn-primary c-pull-right">'+_.escape(r._("send"))+'</button><button class="post-sharing-cancel c-btn c-btn-secondary c-pull-right">'+_.escape(r._("cancel"))+"</button></div>"+feedbackTemplate({ref:"$requestStateFeedback"})+'<div class="post-sharing-shareplane" ref="$shareplane">'+_.escape(r._("sent!"))+"</div></div></div>"),PostSharingState=Backbone.Model.extend({defaults:function(){return{errors:[],options:null,requestState:"UNSENT",selectedOption:null,link:null}}});r.ui.PostSharing=Backbone.View.extend({animationSpeed:200,_template:postSharingTemplate,_model:PostSharingState,events:{"click .post-sharing-link-input":"selectLinkInputText","copy .post-sharing-link-input":"fireCopyEvent","click .post-sharing-option":"setPostSharingOption","click .post-sharing-cancel":"clearPostSharingOption","click .post-sharing-submit":"shareToEmail","click .c-close":"close"},initialize:function(){var $thing=this.options.$thing,fullname=$thing.data("fullname"),title=(fullname.split("_")[1],$thing.find(".entry a.title").text()),link=$thing.find(".entry a.comments").attr("href");this.thingData={fullname:fullname,title:title,link:link};var props=this.options.props||{};props.link=this.getShareLink("link"),this.state=new this._model(props),this.listenTo(this.state,"change",this.render),this.initialRender()},initialRender:function(){var renderVars=this.state.toJSON();renderVars.options&&(renderVars.options=renderVars.options.map(shareOptionTemplate)),this.$el.html(this._template(renderVars)),this.refs={},this.$el.find("[ref]").toArray().forEach(function(ref){var $ref=$(ref),refName=$ref.attr("ref");this.refs[refName]=$ref},this),this.refs.$mainForm.css("display","block"),this.render()},show:function(){this.$el.slideDown(this.animationSpeed,"swing",function(){this.trigger("show",this),this.selectLinkInputText()}.bind(this))},hide:function(){this.$el.slideUp(this.animationSpeed,"swing",function(){this.trigger("hide")}.bind(this))},unmount:function(){this.remove(),this.trigger("unmount",this)},close:function(){this.once("hide",this.unmount.bind(this)),this.hide(),this.trigger("close")},setPostSharingOption:function(e){var option=$(e.target).closest(".post-sharing-option").data("post-sharing-option");switch(option){case"email":case"reddit-pm":return this.state.set({selectedOption:option});case"facebook":return this.shareToFacebook();case"twitter":return this.shareToTwitter();case"tumblr":return this.shareToTumblr();default:this.close()}},getShareLink:function(refSource){var refParams={ref:"share",ref_source:refSource};return r.utils.replaceUrlParams(this.thingData.link,refParams)},shareToFacebook:function(){var redditUrl=this.getShareLink("facebook"),redirectUrl=r.config.currentOrigin+"/share/close",shareParams={app_id:r.config.facebook_app_id,display:"popup",link:redditUrl,description:this.thingData.title,redirect_uri:redirectUrl},shareUrl=r.utils.replaceUrlParams("https://www.facebook.com/dialog/feed",shareParams);this.openWebIntent(shareUrl,"facebook")},shareToTwitter:function(){var redditUrl=this.getShareLink("twitter"),title=this.thingData.title,tweetText=[title,"via","@reddit"].join(" "),tweetTextLength=tweetText.length+25,truncatedTitleLength=title.length-(tweetTextLength-140)-1;140<tweetText.length&&(title=(title=title.slice(0,Math.max(10,truncatedTitleLength))).trim()+"");var shareParams={url:redditUrl,text:title,via:"reddit"},shareUrl=r.utils.replaceUrlParams("https://twitter.com/intent/tweet",shareParams);this.openWebIntent(shareUrl,"twitter")},shareToTumblr:function(){var shareParams={canonicalUrl:this.getShareLink("tumblr"),posttype:"link",title:this.thingData.title},shareUrl=r.utils.replaceUrlParams("https://www.tumblr.com/widgets/share/tool",shareParams);this.openWebIntent(shareUrl,"tumblr")},openWebIntent:function(shareUrl,windowTitle){var windowFeatures={height:420,width:550,left:window.innerWidth/2-275,top:window.innerHeight/2-210},windowFeaturesString=Object.keys(windowFeatures).map(function(key){return key+"="+windowFeatures[key]}).join(",");window.open(shareUrl,windowTitle,windowFeaturesString),this.trigger("web-intent",windowTitle)},shareToEmail:function(){this.state.set({requestState:"LOADING"}),$.request("share",{share_from:"",replyto:"",share_to:this.refs.$shareTo.val(),message:this.refs.$shareMessage.val(),parent:this.thingData.fullname,api_type:"json"},function(res){if("LOADING"===this.state.get("requestState")){var jsonResponse=res.json;if(!jsonResponse)throw"share api response error";jsonResponse.errors.length?this.state.set({errors:jsonResponse.errors,requestState:"DONE"}):(this.state.set({errors:[],requestState:"DONE"}),setTimeout(function(){this.close()}.bind(this),1500))}}.bind(this))},clearPostSharingOption:function(e){this.state.set({requestState:"UNSENT",selectedOption:null})},selectLinkInputText:function(){this.refs.$postSharingLinkInput.focus().select()},fireCopyEvent:function(){this.trigger("link","copy")},getFeedbackRef:function(key){switch(key){case"BAD_EMAIL":case"BAD_EMAILS":case"NO_EMAILS":return this.refs.$shareToFeedback;case"TOO_LONG":return this.refs.$messageFeedback;default:return this.refs.$requestStateFeedback}},onOpenEmailForm:function(){this.refs.$shareTo.focus()},render:function(){var requestState=this.state.get("requestState"),errors=this.state.get("errors"),changed=this.state.changed,selectedOption=this.state.get("selectedOption");"selectedOption"in changed&&(this.refs.$emailFormEmailLabel.toggle("email"===selectedOption),this.refs.$emailFormPMLabel.toggle("reddit-pm"===selectedOption),this.refs.$shareTo.attr("placeholder",this.refs.$shareTo.data("placeholder-"+selectedOption)),"email"===selectedOption||"reddit-pm"===selectedOption?(this.refs.$mainForm.slideUp("fast"),this.refs.$emailForm.slideDown("fast",this.onOpenEmailForm.bind(this))):(this.refs.$mainForm.slideDown("fast"),this.refs.$emailForm.slideUp("fast"))),"email"!==selectedOption&&"reddit-pm"!==selectedOption||(this.refs.$shareToFeedback.stateify("clear"),this.refs.$messageFeedback.stateify("clear"),this.refs.$requestStateFeedback.stateify("clear"),errors.length&&errors.forEach(function(error){var key=error[0],message=error[1];this.getFeedbackRef(key).stateify("set","error",message)},this),"LOADING"===requestState?this.refs.$requestStateFeedback.stateify("set","loading"):"DONE"!==requestState||errors.length||(this.refs.$requestStateFeedback.stateify("set","success"),this.refs.$emailForm.addClass("shared")))}}),$(function(){$("body").on("click",".post-sharing-button",function(e){e.preventDefault();var $parentThing=$(e.target).closest(".thing"),thingId=$parentThing.thing_id();if(r.ui.activeShareMenu&&r.ui.activeShareMenu.$el.is(":visible")){var isSameLink=r.ui.activeShareMenu.options.$thing[0]===$parentThing[0];if(r.ui.activeShareMenu.close(),isSameLink)return}var shareOptions=[{name:"facebook",tooltip:r._("Share to %(name)s").format({name:"Facebook"})},{name:"twitter",tooltip:r._("Share to %(name)s").format({name:"Twitter"})},{name:"tumblr",tooltip:r._("Share to %(name)s").format({name:"Tumblr"})}];r.config.logged&&!r.config.user_in_timeout&&r.config.email_verified&&shareOptions.push({name:"email",tooltip:r._("Email to a Friend")}),r.config.logged&&!r.config.user_in_timeout&&shareOptions.push({name:"reddit-pm",tooltip:r._("Private Message a Friend on Reddit")});var postSharing=new r.ui.PostSharing({className:"post-sharing",$thing:$parentThing,props:{options:shareOptions}});$parentThing.find(".entry .buttons").after(postSharing.el),(r.ui.activeShareMenu=postSharing).on("show",function(){r.analytics.fireGAEvent("post-sharing","open",thingId)}),postSharing.on("unmount",function(){r.ui.activeShareMenu===postSharing&&(r.ui.activeShareMenu=null)}),postSharing.on("close",function(){var eventName=postSharing.state.get("selectedOption")?"close":"cancel";r.analytics.fireGAEvent("post-sharing",eventName,thingId)}),postSharing.on("web-intent",function(refSource){r.analytics.fireGAEvent("post-sharing","share-to-"+refSource,thingId)}),postSharing.on("link",function(action){r.analytics.fireGAEvent("post-sharing","link-"+action,thingId)}),postSharing.show()})})}(r),function(r){function isPluginExpandoButton(elem){return"A"===elem.tagName}var Expando=Backbone.View.extend({buttonSelector:".expando-button",expandoSelector:".expando",expanded:!1,events:{"click .expando-button":"toggleExpando"},constructor:function(){Backbone.View.prototype.constructor.apply(this,_.toArray(arguments)),this.afterInitialize()},initialize:function(){this.$button=this.$el.find(this.buttonSelector),this.$expando=this.$el.find(this.expandoSelector)},afterInitialize:function(){this.expand()},toggleExpando:function(e){isPluginExpandoButton(e.target)||(this.expanded?this.collapse():this.expand())},expand:function(){this.$button.addClass("expanded").removeClass("collapsed"),this.expanded=!0,this.show()},show:function(){this.$expando.show()},collapse:function(){this.$button.addClass("collapsed").removeClass("expanded"),this.expanded=!1,this.hide()},hide:function(){this.$expando.hide()}}),LinkExpando=Expando.extend({events:_.extend({},Expando.prototype.events,{"click .open-expando":"expand"}),initialize:function(){Expando.prototype.initialize.call(this),this.cachedHTML=this.$expando.data("cachedhtml"),this.loaded=!!this.cachedHTML,this.id=this.$el.thing_id(),this.isNSFW=this.$el.hasClass("over18"),this.linkType=this.$el.hasClass("self")?"self":"link",this.autoexpanded=this.options.autoexpanded,this.autoexpanded&&(this.loaded=!0,this.cachedHTML=this.$expando.html());var $e=$.Event("expando:create",{expando:this});if($(document.body).trigger($e),!$e.isDefaultPrevented()){$(document).on("hide_thing_"+this.id,function(){this.collapse()}.bind(this));var linkURL=this.$el.children(".entry").find("a.title").attr("href");if(/^\//.test(linkURL))linkURL=window.location.protocol+"//"+window.location.hostname+linkURL;var eventData={linkIsNSFW:this.isNSFW,linkType:this.linkType,linkURL:linkURL},thingData=this.$el.data();"fullname"in thingData&&(eventData.linkFullname=thingData.fullname),"timestamp"in thingData&&(eventData.linkCreated=thingData.timestamp),"domain"in thingData&&(eventData.linkDomain=thingData.domain),"authorFullname"in thingData&&(eventData.authorFullname=thingData.authorFullname),"subreddit"in thingData&&(eventData.subredditName=thingData.subreddit),"subredditFullname"in thingData&&(eventData.subredditFullname=thingData.subredditFullname),this._expandoEventData=eventData}},collapse:function(){LinkExpando.__super__.collapse.call(this),this.autoexpanded=!1},show:function(){if(!this.loaded)return $.request("expando",{link_id:this.id},function(res){var expandoHTML=$.unsafe(res);this.cachedHTML=expandoHTML,this.loaded=!0,this.show()}.bind(this),!1,"html",!0);var $e=$.Event("expando:show",{expando:this});if(this.$el.trigger($e),!$e.isDefaultPrevented()){if(this.autoexpanded||this.$expando.html(this.cachedHTML),"self"==this.linkType){var $e2=$.Event("expando:hashtml",{expando:this});this.$el.trigger($e2)}if(!this._expandoEventData.provider)this.$expando.children().is("iframe")?this._expandoEventData.provider="embedly":this._expandoEventData.provider="reddit";this.showExpandoContent(),this.fireExpandEvent()}},showExpandoContent:function(){if(this.$expando.removeClass("expando-uninitialized"),this.$expando.show(),"link"==this.linkType){var $img=this.$expando.find("img.preview");$img&&function($wrapper,$link,$img){$wrapper.css("max-width","none"),$link.click(function(event){event.preventDefault()}).mousedown(function(event){event.preventDefault(),$link.data("dragging",!0).data("startX",event.pageX).data("startY",event.pageY),$img.data("original-width",$img.width()).css("width",$img.width()+"px")}).mousemove(function(event){$link.data("dragging")&&$img.css("cursor","nwse-resize").css("width",$img.data("original-width")+event.pageX-$link.data("startX")+event.pageY-$link.data("startY")+"px")}).mouseup(function(event){Math.abs(event.pageX-$link.data("startX")+event.pageY-$link.data("startY"))<=3&&0==event.button&&(location.href=$link.attr("href")),$link.data("dragging",!1),$img.css("cursor","pointer")}).mouseenter(function(event){$link.data("dragging",!1)})}(this.$expando.find(".media-preview"),this.$expando.find(".media-preview-content a"),$img)}},fireExpandEvent:function(){this.autoexpanded?(this.autoexpanded=!1,r.analytics.expandoEvent("expand_default",this._expandoEventData)):r.analytics.expandoEvent("expand_user",this._expandoEventData)},hide:function(){var $e=$.Event("expando:hide",{expando:this});this.$el.trigger($e),$e.isDefaultPrevented()||(this.hideExpandoContent(),this.fireCollapseEvent())},hideExpandoContent:function(){this.$expando.hide().empty()},fireCollapseEvent:function(){r.analytics.expandoEvent("collapse_user",this._expandoEventData)}}),SearchResultLinkExpando=Expando.extend({buttonSelector:".search-expando-button",expandoSelector:".search-expando",events:{"click .search-expando-button":"toggleExpando"},afterInitialize:function(){var expandoHeight=this.$expando.innerHeight();this.$expando.find(".search-result-body").innerHeight()<=expandoHeight?(this.$button.remove(),this.$expando.removeClass("collapsed"),this.undelegateEvents()):this.options.expanded&&this.expand()},show:function(){this.$expando.removeClass("collapsed")},hide:function(){this.$expando.addClass("collapsed")}});$(function(){r.hooks.get("expando-pre-init").call();function initExpando($thing,autoexpanded){if(!$thing.data("expando")){$thing.data("expando",!0);new LinkExpando({el:$thing[0],autoexpanded:autoexpanded})}}$([".linklisting",".organic-listing",".selfserve-subreddit-links"].join(",")).on("click",".expando-button",function(e){isPluginExpandoButton(e.target)||initExpando($(this).closest(".thing"),!1)}),$(".link .expando-button.expanded").each(function(){initExpando($(this).closest(".thing"),!0)}),$(".search-expando-button").closest(".search-result-link").each(function(){new SearchResultLinkExpando({el:this})})})}(r),r,$(function(){var buttonClass="md-expando-button",buttonOpenClass="md-expando-open",buttonClosedClass="md-expando-closed",destroyOnCloseTypes=["video","audio","soundcloud","youtube","invidious","bitchute","peertube","dtube","vimeo"],reValidExpandoUrl=/^https?\:\/\//i,reYouTube=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube(?:-nocookie)?\.com\S*?[^\w\s-])([\w-]{11})(?=[^\w-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/i,reInvidious=/^(?:https?:)?\/\/(?:[0-9A-Z-]+\.)?(?:invidio\.us)\/(?:(?:watch\?(?:[^&=]+=[^&]*)*v=)|embed\/)([\w-]{11})/i,reYouTubeTimestampParam=/t=([^&#]*)/,reYouTubeTimestampA=/^(\d+h)?(\d+m)?(\d+s)$/i,reYouTubeTimestampB=/^(\d+)$/,rePeerTube=/^https?\:\/\/(([^:\/?#]*)(?:\:([0-9]+))?)\/videos\/watch\/(\w{8}\-\w{4}\-\w{4}\-\w{4}\-\w{12})(\?start=(\w+))?$/i,reBitChute=/^https?\:\/\/(www\.)*bitchute\.com\/video\/\w+/i,reDTube=/^https?\:\/\/d\.tube\/(#\!\/)*v\/.+\/\w+/i,reVimeo=/^https?\:\/\/(player\.)*vimeo\.com\/((.+\/.+\/)|(video\/))*(\d+)(#.+)*/i,reSoundCloud=/^https?\:\/\/(www\.)*soundcloud.com\/.+\/.+/i,reImgur=/^https?\:\/\/(www\.|m\.)*imgur.com\/((gallery|t\/\w+|user\/\w+\/favorites|a)\/)*(\w+)$/i;function initMdExpandosByThingId(thingId){$("#"+thingId+" > .entry .md a").each(function(){initMdExpando($(this))}),$("#"+thingId+" > .entry .md a."+buttonClass).on("click",function(event){event.preventDefault(),toggleMdExpando($(this))})}function initMdExpando($thing){if($thing.attr("href").length&&reValidExpandoUrl.exec($thing.attr("href"))){var check=function(href){var allowed=["jpg","jpeg","gif","png","svg","ico","bmp","webp","tif","tiff"],extIndex=allowed.indexOf(getExtension(href).toLowerCase());return-1!=extIndex&&allowed[extIndex].toUpperCase()}($thing.attr("href"));check?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="image" data-expando-exists="false" href="javascript:void(0);">'+check+"</a> "):(check=function(href){var match=reImgur.exec(href);return!(!match||!match[4])&&(match[3]?"a/"+match[4]:match[4])}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="imgur" data-embed-id="'+check+'" data-expando-exists="false" href="javascript:void(0);">Imgur</a> '):(check=function(href){var allowed=["ogg","webm","mpg","mp2","mpeg","mpe","mpv","mp4","m4v","avi","ogv","ogx","webm","3gp","3g2","flv","f4v","f4p","f4f","hevc"],extIndex=allowed.indexOf(getExtension(href).toLowerCase());return-1!=extIndex&&allowed[extIndex].toUpperCase()}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="video" data-expando-exists="false" href="javascript:void(0);">'+check+"</a> "):(check=function(href){var match=reYouTube.exec(href);if(match){match[1]+="?rel=0";var ts=reYouTubeTimestampParam.exec(href);if(ts){var parts=reYouTubeTimestampA.exec(ts[1]);if(parts){var secs=0;parts[3]&&(secs+=parseInt(parts[3].substring(0,parts[3].length-1))),parts[2]&&(secs+=60*parseInt(parts[2].substring(0,parts[2].length-1))),parts[1]&&(secs+=3600*parseInt(parts[1].substring(0,parts[1].length-1))),match[1]+="&start="+secs}else(secs=reYouTubeTimestampB.exec(ts[1]))&&(match[1]+="&start="+parseInt(secs[1]))}return match[1]}return!1}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="youtube" data-video-url="'+check+'" data-expando-exists="false" href="javascript:void(0);">YouTube</a> '):(check=function(href){var match=reInvidious.exec(href);if(match){match[1]+="?rel=0";var ts=reYouTubeTimestampParam.exec(href);if(ts){var parts=reYouTubeTimestampA.exec(ts[1]);if(parts){var secs=0;parts[3]&&(secs+=parseInt(parts[3].substring(0,parts[3].length-1))),parts[2]&&(secs+=60*parseInt(parts[2].substring(0,parts[2].length-1))),parts[1]&&(secs+=3600*parseInt(parts[1].substring(0,parts[1].length-1))),match[1]+="&start="+secs}else(secs=reYouTubeTimestampB.exec(ts[1]))&&(match[1]+="&start="+parseInt(secs[1]))}return match[1]}return!1}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="invidious" data-video-url="'+check+'" data-expando-exists="false" href="javascript:void(0);">Invidious</a> '):(check=function(href){return!!rePeerTube.exec(href)&&href.replace("/videos/watch/","/videos/embed/")}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="peertube" data-video-url="'+check+'" data-expando-exists="false" href="javascript:void(0);">PeerTube</a> '):(check=function(href){return!!reBitChute.exec(href)&&href.replace("/video/","/embed/")}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="bitchute" data-video-url="'+check+'" data-expando-exists="false" href="javascript:void(0);">BitChute</a> '):(check=function(href){return!!reDTube.exec(href)&&(href=(href=href.replace("d.tube/#!/v/","d.tube/#!/")).replace("d.tube/v/","d.tube/#!/")).replace("d.tube/","emb.d.tube/")}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="dtube" data-video-url="'+check+'" data-expando-exists="false" href="javascript:void(0);">DTube</a> '):(check=function(href){var match=reVimeo.exec(href);if(match&&match[5]){var url="https://player.vimeo.com/video/"+match[5];return match[6]&&(url+=match[6]),url}return!1}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="vimeo" data-video-url="'+check+'" data-expando-exists="false" href="javascript:void(0);">Vimeo</a> '):(check=function(href){var allowed=["wav","m4p","mp3","m4a","aac","oga","mid","midi","weba","f4a","f4b","opus"],extIndex=allowed.indexOf(getExtension(href).toLowerCase());return-1!=extIndex&&allowed[extIndex].toUpperCase()}($thing.attr("href")))?$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="audio" data-expando-exists="false" href="javascript:void(0);">'+check+"</a> "):(check=reSoundCloud.exec($thing.attr("href")))&&$thing.after(' <a class="'+buttonClass+" "+buttonClosedClass+'" data-type="soundcloud" data-url="'+$thing.attr("href")+'" data-expando-exists="false" href="javascript:void(0);">SoundCloud</a> ')}}function toggleMdExpando($button){if($button.hasClass(buttonOpenClass))return $button.addClass(buttonClosedClass).removeClass(buttonOpenClass),$button.next().hide(),void(-1!=destroyOnCloseTypes.indexOf($button.data("type"))&&$button.data("expando-exists",!1).next().remove());if($button.addClass(buttonOpenClass).removeClass(buttonClosedClass),1!=$button.data("expando-exists"))switch($button.data("expando-exists",!0),$button.data("type")){case"image":var sourceHref=$button.prev().attr("href");$button.after('<div class="md-expando"><a href="'+sourceHref+'" draggable="false" style="outline: none;"><img src="'+sourceHref+'" draggable="false"/></a></div>'),function($link,$img){$link.click(function(event){event.preventDefault()}).mousedown(function(event){event.preventDefault(),$link.data("dragging",!0).data("startX",event.pageX).data("startY",event.pageY),$img.data("original-width",$img.width()).css("width",$img.width()+"px").css("max-width","none")}).mousemove(function(event){$link.data("dragging")&&$img.css("cursor","nwse-resize").css("width",$img.data("original-width")+event.pageX-$link.data("startX")+event.pageY-$link.data("startY")+"px")}).mouseup(function(event){Math.abs(event.pageX-$link.data("startX")+event.pageY-$link.data("startY"))<=3&&0==event.button&&(location.href=$link.attr("href")),$link.data("dragging",!1),$img.css("cursor","pointer")}).mouseenter(function(event){$link.data("dragging",!1)})}($button.next().find("a"),$button.next().find("img"));break;case"video":$button.after('<div class="md-expando"><video controls preload="auto" src="'+$button.prev().attr("href")+'"></video></div>');break;case"audio":$button.after('<div class="md-expando"><audio controls preload="auto" src="'+$button.prev().attr("href")+'"></audio></div>');break;case"imgur":var html='<blockquote class="imgur-embed-pub" lang="en" data-id="'+$button.data("embed-id")+'"><a href="//imgur.com/'+$button.data("embed-id")+'"></a></blockquote><script async src="//s.imgur.com/min/embed.js" charset="utf-8"><\/script>';$button.after('<div class="md-expando">'+html+"</div>");break;case"youtube":$button.after('<div class="md-expando"><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/'+$button.data("video-url")+'" frameborder="0" allow="autoplay; encrypted-media" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>');break;case"invidious":$button.after('<div class="md-expando"><iframe width="560" height="315" src="https://www.invidio.us/embed/'+$button.data("video-url")+'" frameborder="0" allow="autoplay; encrypted-media" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>');break;case"peertube":$button.after('<div class="md-expando"><iframe width="560" height="315" sandbox="allow-same-origin allow-scripts" src="'+$button.data("video-url")+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>');break;case"bitchute":$button.after('<div class="md-expando"><iframe width="640" height="360" scrolling="no" frameborder="0" style="border: none;" src="'+$button.data("video-url")+'" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>');break;case"dtube":$button.after('<div class="md-expando"><iframe width="560" height="315" src="'+$button.data("video-url")+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>');break;case"vimeo":$button.after('<div class="md-expando"><iframe width="640" height="360" src="'+$button.data("video-url")+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>');break;case"soundcloud":$.getJSON("https://soundcloud.com/oembed?url="+encodeURIComponent($button.data("url")),function(data){$button.after('<div class="md-expando">'+data.html+"</div>")})}else $button.next().show()}function getExtension(href){var trimIndex=href.indexOf("#");return-1!==trimIndex&&(href=href.slice(0,trimIndex)),-1!==(trimIndex=href.indexOf("?"))&&(href=href.slice(0,trimIndex)),href.split(".").pop()}$(".md a").each(function(){initMdExpando($(this))}),$(".md a."+buttonClass).on("click",function(event){event.preventDefault(),toggleMdExpando($(this))}),$(document).on("new_thing",function(event,thing){initMdExpandosByThingId(thing.getAttribute("id"))}),$(document).on("expando:hashtml",function(event){initMdExpandosByThingId("thing_"+event.expando.id)})}),r.saved={},r.saved.SaveCategories=Backbone.Collection.extend({model:Backbone.Model.extend({idAttribute:"category"}),url:"/api/saved_categories.json",fetchOnce:function(){return this._fetched||(this._fetched=this.fetch()),this._fetched},comparator:function(item){return item.get("category")},parse:function(response){return response.categories}}),r.saved.SaveDialog=r.ui.Bubble.extend({tagName:"form",className:"hover-bubble anchor-left save-selector",confirmTemplate:_.template('<label for="savedcategory"><%- label %></label><span class="throbber"></span><select><option value=""><%- placeholder %></option></select><input maxlength="20" class="savedcategory"  name="savedcategory" placeholder="<%- textplaceholder %>"><input type="submit" value="<%- save %>"><div class="error"></div>'),events:{click:"clicked",submit:"save",mouseout:"mouseout",mouseover:"cancelTimeout","change select":"change"},mouseout:function(){this.$el.find("select, .savedcategory").is(":focus")||this.queueHide()},clicked:function(e){e.stopPropagation()},initialize:function(options){this.options=options,this.options.trackHover=!1,r.ui.Bubble.prototype.initialize.apply(this),r.saved.categories.fetchOnce().then(_.bind(this.show,this)),$("body").on("click.savedialog",_.bind(this.hideNow,this))},hideNow:function(){r.ui.Bubble.prototype.hideNow.apply(this),$("body").off("click.savedialog"),this.remove()},error:function(){this.$el.find("select, .savedcategory").attr("disabled",!1),this.$el.removeClass("working"),this.$el.find(".error").text(r._("Invalid category name"))},change:function(e){var input=this.$el.find(".savedcategory"),selected=this.$el.find("option:selected").val();input.val(selected).focus()},success:function(){var $category=this.$parent.parents(".thing").find(".save-category");$category.length&&this.category?($category.text("category: "+this.category),$category.attr("href","/user/"+r.config.logged+"/saved/"+this.category),$category.show()):$category.hide(),r.saved.SaveButton.setSaved(this.$parent),this.category&&(r.saved.categories.add({category:this.category}),r.saved.categories.sort()),this.hide()},save:function(e){if(e.preventDefault(),this.category=this.$el.find(".savedcategory").val(),this.$el.find("select, .savedcategory").attr("disabled",!0),!this.category)return this.success();this.$el.addClass("working"),r.ajax({type:"POST",url:"/api/save",data:{id:this.$parent.thing_id(),category:this.category},success:this.success,error:this.error,context:this})},addCategory:function(category){var value=category.get("category");this.$el.find("select").append($("<option>").val(value).text(value))},show:function(){r.ui.Bubble.prototype.show.apply(this),this.$el.find(".savedcategory").focus()},render:function(){this.$el.html(this.confirmTemplate({label:r._("save category"),placeholder:r._("no category"),save:r._("save"),textplaceholder:r._("new category")})),r.saved.categories.each(this.addCategory,this),this.$el.find("select").first().prop("selected",!0)}}),r.saved.SaveButton={request:function($el,type,callback){r.ajax({type:"POST",url:"/api/"+type,data:{id:$el.thing_id()},success:_.bind(callback,this,$el)})},toggleSaved:function($el){this.isSaved($el)?this.unsave($el):this.save($el)},unsave:function($el){this.request($el,"unsave",this.setUnsaved)},save:function($el){this.request($el,"save",this.setSaved),r.config.gold&&new r.saved.SaveDialog({parent:$el,group:r.saved.SaveButton})},isSaved:function($el){return $el.thing().hasClass("saved")},setUnsaved:function($el){$el.parents(".thing").find(".save-category").hide();$el.text(r._("save")),$el.thing().removeClass("saved")},setSaved:function($el){$el.text(r._("unsave")),$el.thing().addClass("saved")}},r.saved.categories=new r.saved.SaveCategories,r.saved.init=function(){$("body").on("click",".save-button a, a.save-button",function(e){e.stopPropagation(),e.preventDefault(),r.saved.SaveButton.toggleSaved($(this))})},function(global,$,r){"use strict";function generateCanary(){return function(stringLen){for(var id="",chars="abcdefghijklmnopqrstuvwxyz0123456789",i=0;i<stringLen;i++)id+=chars.charAt(Math.floor(Math.random()*chars.length));return id}(2)}r.cachePoisoning={},r.cachePoisoning.updateCanaryCookie=function(){var canary=$.cookie("pc");canary=canary||generateCanary(),$.cookie("pc",null,{secure:r.config.https_forced,domain:r.config.cur_domain}),$.cookie("pc",canary,{secure:r.config.https_forced,domain:r.config.cur_domain,path:"/",expires:365})},r.cachePoisoning.checkPoisoned=function(){var clientCanary=$.cookie("pc");return!(!clientCanary||!r.config.poisoning_canary||clientCanary===r.config.poisoning_canary)},r.cachePoisoning._parseHeaders=function(headersString){for(var match,rheaders=/^(.*?):[ \t]*([^\r\n]*)$/gm,headersHash={};match=rheaders.exec(headersString);){var headerName=match[1].toLowerCase();void 0===headersHash[headerName]&&(headersHash[headerName]=[]),headersHash[headerName].push(match[2])}return headersHash},r.cachePoisoning.logPoisoning=function(){var poisonDetails={report_mac:r.config.poisoning_report_mac,poisoner_name:r.config.logged,poisoner_id:r.config.user_id,cache_policy:r.config.cache_policy,poisoner_canary:r.config.poisoning_canary,victim_canary:$.cookie("pc"),render_time:r.config.server_time,route_name:r.config.pageInfo.actionName,source:"web",url:window.location.href||"",resp_headers:{}};$.ajax({url:window.location.href,xhr:function(){var xhr=jQuery.ajaxSettings.xhr(),setRequestHeader=xhr.setRequestHeader;return xhr.setRequestHeader=function(name,value){"X-Requested-With"!==name&&setRequestHeader.call(this,name,value)},xhr},complete:function(xhr){if(-1!==(xhr.responseText||"").indexOf(r.config.modhash)){var hdrs=xhr.getAllResponseHeaders();poisonDetails.resp_headers=r.cachePoisoning._parseHeaders(hdrs)}poisonDetails.resp_headers=JSON.stringify(poisonDetails.resp_headers),r.ajax({type:"POST",url:"/web/poisoning.json",data:poisonDetails,headers:{"X-Loggit":!0},success:function(){r.log("Sent cache poisoning report to server")},error:function(xhr,err,status){r.warn("Error sending cache poisoning report to server")}})}})},r.cachePoisoning.init=function(){r.config.logged&&r.cachePoisoning.checkPoisoned()&&r.cachePoisoning.logPoisoning(),r.cachePoisoning.updateCanaryCookie()}}(window,jQuery,r),r.messages={},r.messages.pollUnread=_.debounce(function(count){20<(count=count+1||1)?document.location="/message/unread":r.ajax({type:"GET",url:"/api/me.json",success:function(response){response.data.has_mail?r.messages.pollUnread(count):document.location="/message/unread"}})},2e3),r.messages.init=function(){$("a.mark-all-read").on("click",function(e){var $this=$(this);e.preventDefault(),e.stopPropagation(),$this.hasClass("disabled")||($this.addClass("disabled"),$this.parent().addClass("working"),r.ajax({type:"POST",url:"/api/read_all_messages",data:{},success:function(response){r.messages.pollUnread()},error:function(response){$this.parent().removeClass("working")}}))})},function(r){r.hooks.get("reddit").register(function(){try{r.setupBackbone(),r.login.ui.init(),r.TimeText.init(),r.ui.init(),r.interestbar.init(),r.visited.init(),r.apps.init(),r.wiki.init(),r.gold.init(),r.multi.init(),r.recommend.init(),r.saved.init(),r.messages.init(),r.filter.init(),r.newsletter.ui.init(),r.cachePoisoning.init(),r.locked.init()}catch(err){r.sendError("Error during reddit.js init",err.toString())}}),$(function(){r.hooks.get("reddit").call()})}(r),$(function(){var clientTime=Date.now(),serverTime=1e3*r.config.server_time,disabledDueToDrift=!1,beaconsEnabled=r.config.feature_outbound_beacons&&"sendBeacon"in window.navigator,beaconURL=null;function setOutboundURL(elem){var url,$elem=$(elem),now=Date.now();return $elem.attr("data-inbound-url")?url=$elem.attr("data-inbound-url"):!disabledDueToDrift&&$elem.attr("data-outbound-expiration")>now&&(url=$elem.attr("data-outbound-url")),url&&(beaconsEnabled?beaconURL=url:elem.href=url),!0}function resetOriginalURL(elem){return beaconsEnabled?beaconURL=null:elem.href=$(elem).attr("data-href-url"),!0}clientTime+3e5<serverTime&&(disabledDueToDrift=!0),serverTime<clientTime-36e5&&(disabledDueToDrift=!0);var $delegate=$("a[data-outbound-url], a[data-inbound-url], .sitetable, organic-listing"),linkSelector="a[data-outbound-url], a[data-inbound-url]";$delegate.on("mousedown",linkSelector,function(e){return 3===e.which||setOutboundURL(this)}),$delegate.on("mouseleave",linkSelector,function(){return resetOriginalURL(this)}),$delegate.on("keydown",linkSelector,function(e){return 13===e.which&&setOutboundURL(this),!0}),$delegate.on("keyup",linkSelector,function(e){return 13!==e.which&&17!==e.which||resetOriginalURL(this),!0}),$delegate.on("touchstart",linkSelector,function(e){return setOutboundURL(this)}),$(window).on("unload",function(){if(beaconsEnabled&&null!==beaconURL){var tempA=$("<a>",{href:beaconURL})[0],beaconPath=tempA.protocol+"//"+tempA.hostname+tempA.pathname,beaconPayload=tempA.search.replace(/^\?/,"");navigator.sendBeacon(beaconPath,beaconPayload)}})}),$(function(){r.warn_on_unload=function(){$(window).on("beforeunload",function(e){var form=$("form.warn-on-unload");if($(form).length){var elements=form.find("input[type=text],input[type=checkbox],input[type=url],textarea").not(":hidden"),isDirty=!1;return elements.each(function(){switch(this.type){case"checkbox":isDirty=this.defaultChecked!==this.checked;break;case"textarea":case"text":case"url":isDirty=this.defaultValue!==this.value;break;default:return!0}if(isDirty)return!1}),isDirty?r._("You have unsaved changes!"):void 0}})},$("form.warn-on-unload").on("keypress",function(e){$(window).off("beforeunload"),r.warn_on_unload()}),$(".usertext.warn-on-unload textarea").not(":hidden").not("form#newlink .usertext textarea").on("blur",function(e){this.defaultValue===this.value&&$(window).off("beforeunload")})}),function(r){r.config.imgur_client_id.length&&$(function(){$("#imgur-upload").on("click",function(e){!$("#url").val()||confirm("This will replace your existing url, proceed?")||e.preventDefault()}),$("#imgur-upload").on("change",function(){var files=$(this).get(0).files;if(files.length){$("#url-field .title-status").css("display","block").text("uploading...");var formData=new FormData;formData.append("image",files[0]),$.ajax({crossDomain:!0,processData:!1,contentType:!1,data:formData,dataType:"json",type:"POST",url:"https://api.imgur.com/3/image",headers:{Authorization:"Client-ID "+r.config.imgur_client_id},mimeType:"multipart/form-data"}).done(function(response){1==response.success&&200==response.status?($("#url-field .title-status").css("display","block").text(""),$("#url").val(response.data.link)):($("#url-field .title-status").css("display","block").html('upload failed, try again or visit <a href="https://imgur.com/upload">https://imgur.com/upload</a>'),$("#url").val(""))}).fail(function(xhr,textStatus,error){$("#url-field .title-status").css("display","block").html('upload failed, try again or visit <a href="https://imgur.com/upload">https://imgur.com/upload</a>'),$("#url").val("")})}})})}(r),r.permissions=_.extend(r.permissions||{},{moderator:{wiki:{description:r.N_("manage the wiki and access to the wiki"),title:r.N_("wiki")},access:{description:r.N_("manage the lists of contributors and banned/muted users"),title:r.N_("access")},mail:{description:r.N_("read and reply to moderator mail"),title:r.N_("mail")},config:{description:r.N_("edit settings, sidebar, css, images, and AutoModerator config"),title:r.N_("config")},posts:{description:r.N_("use the approve, remove, spam, distinguish, and nsfw buttons"),title:r.N_("posts")},flair:{description:r.N_("manage user flair, link flair, and flair templates"),title:r.N_("flair")}},moderator_invite:{wiki:{description:r.N_("manage the wiki and access to the wiki"),title:r.N_("wiki")},access:{description:r.N_("manage the lists of contributors and banned/muted users"),title:r.N_("access")},mail:{description:r.N_("read and reply to moderator mail"),title:r.N_("mail")},config:{description:r.N_("edit settings, sidebar, css, images, and AutoModerator config"),title:r.N_("config")},posts:{description:r.N_("use the approve, remove, spam, distinguish, and nsfw buttons"),title:r.N_("posts")},flair:{description:r.N_("manage user flair, link flair, and flair templates"),title:r.N_("flair")}}})}catch(err){r.sendError("Error running module","reddit.js",":",err.toString())}
r.i18n.addMessages({"wiki": [null, "wiki"], "full permissions": [null, "full permissions"], "a month ago": [null, "a month ago", "%(num)s months ago"], "invalid cvc": [null, "invalid cvc"], "missing city": [null, "missing city"], "sent!": [null, "sent!"], "Email to a Friend": [null, "Email to a Friend"], "an hour ago": [null, "an hour ago", "%(num)s hours ago"], "just now": [null, "just now"], "cancel": [null, "cancel"], "Learn more": [null, "Learn more"], "save category": [null, "save category"], "Embed preview:": [null, "Embed preview:"], "This parameter can be changed after embedding.": [null, "This parameter can be changed after embedding."], "an error occurred (status: %(status)s)": [null, "an error occurred (status: %(status)s)"], "categorize": [null, "categorize"], "yes": [null, "yes"], "add a subreddit to your multi.": [null, "add a subreddit to your multi"], "this is too short (min: %(min_length)s)": [null, "this is too short (min: %(min_length)s)"], "new category": [null, "new category"], "awesomeness goes here": [null, "awesomeness goes here"], "passwords do not match": [null, "passwords do not match"], "open this multi": [null, "open this multi"], "a day ago": [null, "a day ago", "%(num)s days ago"], "no permissions": [null, "no permissions"], "use the approve, remove, spam, distinguish, and nsfw buttons": [null, "use the approve, remove, spam, distinguish, and nsfw buttons"], "send": [null, "send"], "add optional message": [null, "add optional message"], "config": [null, "config"], "create a new multi": [null, "create a new multi"], "invalid expiration date": [null, "invalid expiration date"], "access": [null, "access"], "Share via email as %(username)s": [null, "Share via email as %(username)s"], "read and reply to moderator mail": [null, "read and reply to moderator mail"], "a minute ago": [null, "a minute ago", "%(num)s minutes ago"], "Link:": [null, "Link:"], "Password is strong": [null, "Password is strong"], "Share to %(name)s": [null, "Share to %(name)s"], "are you sure?": [null, "are you sure?"], "close this window": [null, "close this window"], "flair": [null, "flair"], "missing address": [null, "missing address"], "missing country": [null, "missing country"], "Password is fair": [null, "Password is okay"], "Password is weak": [null, "Password is weak"], "missing name": [null, "missing name"], "invalid credit card number": [null, "invalid credit card number"], "Password is good": [null, "Password is good"], "a year ago": [null, "a year ago", "%(num)s years ago"], "no": [null, "no"], "mail": [null, "mail"], "Do not show comment if edited.": [null, "Do not show comment if edited."], "Copy this code and paste it into your website:": [null, "Copy this code and paste it into your website:"], "Include parent comment.": [null, "Include parent comment."], "save": [null, "save"], "Share with:": [null, "Share with:"], "edit settings, sidebar, css, images, and AutoModerator config": [null, "edit settings, sidebar, css, images, and AutoModerator config"], "try using our secure login form.": [null, "try using our secure login form."], "posts": [null, "posts"], "manage user flair, link flair, and flair templates": [null, "manage user flair, link flair, and flair templates"], "check your inbox to confirm your subscription": [null, "check your inbox to confirm your subscription"], "manage the wiki and access to the wiki": [null, "manage the wiki and access to the wiki"], "we need something here": [null, "we need something here"], "an error occurred. please try again later! (status: %(status)s)": [null, "an error occurred. please try again later! (status: %(status)s)"], "Invalid category name": [null, "Invalid category name"], "When checked, if an embedded comment is later edited, the embedded comment text will be replaced by a link back to the current version of the comment on reddit.": [null, "When checked, if an embedded comment is later edited, the embedded comment text will be replaced by a link back to the current version of the comment on reddit."], "unsave": [null, "unsave"], "no category": [null, "no category"], "this is too long (max: %(max_length)s)": [null, "this is too long (max: %(max_length)s)"]});