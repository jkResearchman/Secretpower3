r.templates.set([{style:"html",name:"ui/formbar",template:'<form class="form-bar c-clearfix">\n  <div class="md-container-small">\n    <div class="md">\n      <p class="form-bar-text"><%- thing.text %></p>\n    </div>\n    \n    <button type="submit" class="c-btn c-btn-primary"><%- thing.buttonLabel %></button>\n  </div>\n  <input type="hidden" name="<%- thing.key %>" value="<%- thing.value %>">\n</form>\n'}]),function(r){r.ui.FormBar=Backbone.View.extend({templateName:"ui/formbar",defaults:{text:"",buttonLabel:"",key:"",value:""},events:{"submit .form-bar":"onSubmit"},initialize:function(){var templateProps=_.defaults(this.options,this.defaults);this.render(templateProps)},render:function(templateProps){var content=r.templates.make(this.templateName,templateProps);this.$el.html(content)},onSubmit:function(e){e.preventDefault(),this.trigger("submit",get_form_fields(e.target))}})}(r),r.templates.set([{style:"html",name:"expando/nsfwgate",template:'<div class="expando-nsfw-gate expando-nsfw-<%- thing.style %> expando-nsfw-<%- thing.type %>"\n        style="width: 100%; height: 100%;">  \x3c!-- style="width: <%- thing.width %>; height: <%- thing.height %>" --\x3e \n    <div class="expando-nsfw-gate-controls">\n        <button class="expando-nsfw-gate-show-once"><%- thing.buttonLabel %></button>\n        <p class="expando-nsfw-gate-text"><%- thing.text %></p>\n    </div>\n</div>\n'}]),function(r){var _state={over18Listing:!1,noProfanity:!0,nsfwMediaAcknowledged:!1,loggedIn:!1};r.hooks.get("setup").register(function(){_state.over18Listing=r.config.listing_over_18,_state.noProfanity=r.config.pref_no_profanity,_state.nsfwMediaAcknowledged=r.config.nsfw_media_acknowledged,_state.loggedIn=!!r.config.logged});var ExpandoInlinePreferenceForm=r.ui.FormBar.extend({doneString:r._("We will ask before showing NSFW media."),defaults:{text:"",buttonLabel:"",key:"show_nsfw_media",value:""},render:function(templateProps){this._lastRenderProps=templateProps,ExpandoInlinePreferenceForm.__super__.render.call(this,templateProps)},onSubmit:function(e){ExpandoInlinePreferenceForm.__super__.onSubmit.call(this,e);var templateProps=_.defaults({text:this.doneString},this._lastRenderProps);this.render(templateProps),this.$el.addClass("expando-nsfw-flow-complete"),this.$el.find("button").remove(),this.$el.find("form").attr("disabled",!0)}}),ExpandoNSFWGate=Backbone.View.extend({templateName:"expando/nsfwgate",events:{"click .expando-nsfw-gate-show-once":"onButtonClick","click .expando-nsfw-gate-text":"onTextClick"},defaults:{buttonLabel:r._("Click to see NSFW"),text:"",type:"normal",style:"interstitial"},initialize:function(){this.render(this.options)},render:function(templateProps){templateProps=_.defaults(templateProps,this.defaults);var content=r.templates.make(this.templateName,templateProps);this.$el.html(content)},onButtonClick:function(e){e.preventDefault(),this.trigger("click:button")},onTextClick:function(e){e.preventDefault(),this.trigger("click:text")}}),ExpandoNSFWFlow=Backbone.View.extend({strings:{normal:r._("Always show NSFW media?"),changedToShow:r._("Ok, we changed your preferences to always show NSFW media."),changedToShowLabel:r._("Undo"),warning:r._("Your account is set up to always show this content in the future."),alwaysAsk:r._("Change your preferences to hide NSFW media?"),alwaysAskLabel:r._("Hide NSFW")},initialize:function(){var width=this.options.width,height=this.options.height,isOverlay=this.options.isOverlay,isWarning=this.options.isWarning;this.isOverlay=this.options.isOverlay,this.isWarning=this.options.isWarning;var interstitialOptions={width:width?width+"px":"100%",height:height?height+"px":"100%",style:isOverlay?"overlay":"interstitial",type:isWarning?"warning":"normal"};_state.loggedIn&&(this.isWarning?interstitialOptions.text=this.strings.warning:interstitialOptions.text=this.strings.normal),this.interstitial=new ExpandoNSFWGate(interstitialOptions),this.$el.append(this.interstitial.el),this.listenTo(this.interstitial,"click:button",this.onShowOnce),_state.loggedIn&&(this.isWarning?this.initFormBar():this.listenTo(this.interstitial,"click:text",this.onShowAlways))},initFormBar:function(){var text,buttonLabel;buttonLabel=this.isWarning?(text=this.strings.alwaysAsk,this.strings.alwaysAskLabel):(text=this.strings.changedToShow,this.strings.changedToShowLabel),this.formBar=new ExpandoInlinePreferenceForm({text:text,buttonLabel:buttonLabel,value:"off"}),this.$el.append(this.formBar.el),this.listenTo(this.formBar,"submit",this.updatePref)},onShowOnce:function(){_state.nsfwMediaAcknowledged?this.show():(_state.nsfwMediaAcknowledged=!0,this._updateNsfwMediaPrefs({},this.show.bind(this)))},onShowAlways:function(){this.updatePref({show_nsfw_media:"on"}),this.initFormBar()},updatePref:function(fields){_state.noProfanity="off"===fields.show_nsfw_media,this._updateNsfwMediaPrefs(fields,function(){"on"===fields.show_nsfw_media&&this.show()}.bind(this))},_updateNsfwMediaPrefs:function(fields,cb){$.request("set_nsfw_media_pref",fields,function(res){cb&&cb()},!1,"json",!1)},show:function(){this.trigger("show"),this.isOverlay?this.interstitial.$el.fadeOut():this.interstitial.$el.remove()}});r.hooks.get("expando-pre-init").register(function(){$(document.body).on("expando:create",function(e){var nsfwFlow,expando=e.expando;!_state.noProfanity&&_state.nsfwMediaAcknowledged||!expando.isNSFW||"link"!=expando.linkType||(expando.$el.on("expando:show",showNsfwFlow),expando.$el.on("expando:hide",hideNsfwFlow));function showNsfwFlow(e){e.preventDefault(),expando.autoexpanded||expando.$expando.html(expando.cachedHTML);var $expando=expando.$expando,$media=$expando.children(),height=($media.width(),$media.height()),isOverlay=$media.hasClass("media-preview"),isWarning=!_state.noProfanity;nsfwFlow=new ExpandoNSFWFlow({height:height,isOverlay:isOverlay,isWarning:isWarning}),expando.$expando.addClass("expando-with-nsfw-interstitial"),expando.listenTo(nsfwFlow,"show",destroyNsfwFlow),nsfwFlow.isOverlay?$media.append(nsfwFlow.el):$expando.html(nsfwFlow.el),expando.showExpandoContent()}function hideNsfwFlow(e){e.preventDefault(),expando.hideExpandoContent()}function destroyNsfwFlow(){expando.stopListening(nsfwFlow,"show",destroyNsfwFlow),expando.$expando.removeClass("expando-with-nsfw-interstitial"),nsfwFlow.isOverlay||expando.$expando.prepend(expando.cachedHTML),expando.fireExpandEvent(),expando.$el.off("expando:show",showNsfwFlow),expando.$el.off("expando:hide",hideNsfwFlow)}})})}(r);
